<?php

/**
 * Processwire module for running the Tracy debugger from Nette.
 * by Adrian Jones
 *
 * ProcessWire 3.x
 * Copyright (C) 2011 by Ryan Cramer
 * Licensed under GNU/GPL v2, see LICENSE.TXT
 *
 * http://www.processwire.com
 * http://www.ryancramer.com
 *
 *
 * A big thanks to Roland Toth (https://github.com/rolandtoth/) for the idea for this module
 * and for significant feedback, testing, and feature suggestions.
 *
 */

use Tracy\Debugger;
use Tracy\Helpers;
use Tracy\Dumper;

class TracyDebugger extends WireData implements Module, ConfigurableModule {

    /**
     * Basic information about module
     */
    public static function getModuleInfo() {
        return array(
            'title' => __('Tracy Debugger', __FILE__),
            'summary' => __('Tracy debugger from Nette with several PW specific custom tools.', __FILE__),
            'author' => 'Adrian Jones',
            'href' => 'https://processwire.com/talk/topic/12208-tracy-debugger/',
            'version' => '4.9.18',
            'autoload' => true,
            'singular' => true,
            'requires'  => 'ProcessWire>=2.7.2, PHP>=5.4.4',
            'icon' => 'bug',
        );
    }


    const COOKIE_SECRET = 'tracy-debug';

    protected $data = array();
    protected $httpReferer;
    protected $tracyEnabled = false;
    protected $tracyCacheDir;
    protected $modulesDbBackupFilename;
    protected static $useOnlineEditor;
    protected static $onlineEditor;
    protected static $onlineFileEditorDirPath;
    public static $inAdmin;
    public static $isLocal = false;
    public static $tracyVersion;
    public static $dumpItems = array();
    public static $pageFinderQueries = array();
    public static $templateVars = array();
    public static $templateConsts = array();
    public static $initialFuncs = array();
    public static $initialConsts = array();
    public static $templateFuncs = array();
    public static $includedFiles = array();
    public static $fromConsole = false;
    public static $oncePanels;
    public static $stickyPanels;
    public static $showPanels;
    public static $disabableModules = array();
    public static $restrictedUserDisabledPanels = array();
    public static $disabledModules = array();
    public static $templatePath;
    public static $pageVersion;
    public static $templatePathOnce;
    public static $templatePathSticky;
    public static $templatePathPermission;
    public static $tempTemplateFilename;
    public static $panelGenerationTime = array();
    public static $hideInAdmin = array('validator', 'templateResources', 'templatePath');
    public static $pageHtml;
    public static $processWireInfoSections = array(
        'apiVariables' => 'API Variables',
        'coreClasses' => 'Core Classes',
        'configData' => 'Config Data',
        'versionsList' => 'Versions List',
        'adminLinks' => 'Admin Links',
        'documentationLinks' => 'Documentation Links',
        'gotoId' => 'Goto Page By ID',
        'processWireWebsiteSearch' => 'ProcessWire Website Search'
    );
    public static $requestInfoSections = array(
        'moduleSettings' => 'Module Settings',
        'templateSettings' => 'Template Settings',
        'fieldSettings' => 'Field Settings',
        'pageInfo' => 'Page Info',
        'languageInfo' => 'Language Info',
        'templateInfo' => 'Template Info',
        'fieldsListValues' => 'Field List & Values',
        'serverRequest' => 'Server Request',
        'inputGet' => 'Input GET',
        'inputPost' => 'Input POST',
        'inputCookie' => 'Input COOKIE',
        'session' => 'SESSION',
        'pageObject' => 'Page Object',
        'templateObject' => 'Template Object',
        'fieldsObject' => 'Fields Object',
        'editLinks' => 'Page/Template Edit Links'
    );
    public static $debugModeSections = array(
        'pagesLoaded' => 'Pages Loaded',
        'modulesLoaded' => 'Modules Loaded',
        'hooks' => 'Hooks Triggered',
        'databaseQueries' => 'Database Queries',
        'selectorQueries' => 'Selector Queries',
        'timers' => 'Timers',
        'user' => 'User',
        'cache' => 'Cache',
        'autoload' => 'Autoload'
    );
    public static $diagnosticsSections = array(
        'filesystemFolders' => 'Filesystem Folders',
        'filesystemFiles' => 'Filesystem Files',
        'mysqlInfo' => 'MySQL Info'
    );
    public static $allPanels = array(
        'captainHook' => 'Captain Hook',
        'console' => 'Console',
        'customPhp' => 'Custom PHP',
        'debugMode' => 'Debug Mode',
        'diagnostics' => 'Diagnostics',
        'dumpsRecorder' => 'Dumps Recorder',
        'eventInterceptor' => 'Event Interceptor',
        'fileEditor' => 'File Editor',
        'gitInfo' => 'Git Info',
        'mailInterceptor' => 'Mail Interceptor',
        'methodsInfo' => 'Methods Info',
        'moduleDisabler' => 'Module Disabler',
        'outputMode' => 'Output Mode',
        'pageRecorder' => 'Page Recorder',
        'panelSelector' => 'Panel Selector',
        'performance' => 'Performance',
        'phpInfo' => 'PHP Info',
        'processwireInfo' => 'ProcessWire Info',
        'processwireLogs' => 'ProcessWire Logs',
        'processwireVersion' => 'ProcessWire Version',
        'requestInfo' => 'Request Info',
        'snippetRunner' => 'Snippet Runner',
        'templatePath' => 'Template Path',
        'templateResources' => 'Template Resources',
        'todo' => 'ToDo',
        'tracyToggler' => 'Tracy Toggler',
        'tracyLogs' => 'Tracy Logs',
        'userSwitcher' => 'User Switcher',
        'users' => 'Users',
        'validator' => 'Validator'
    );
    public static $userBarFeatures = array(
        'admin' => 'Admin',
        'editPage' => 'Edit Page',
        'pageVersions' => 'Page Versions'
    );

   /**
     * Default configuration for module
     *
     */
    static public function getDefaultData() {
        return array(
            "enabled" => 1,
            //"coreBranch" => version_compare(phpversion(), '5.4.4', '>=') ? 'master' : 'legacy',
            "coreBranch" => 'master',
            "superuserForceDevelopment" => null,
            "guestForceDevelopmentLocal" => null,
            "ipAddress" => null,
            "strictMode" => null,
            "strictModeAjax" => null,
            "forceScream" => null,
            "outputMode" => 'detect',
            "showLocation" => array('Tracy\Dumper::LOCATION_SOURCE', 'Tracy\Dumper::LOCATION_LINK', 'Tracy\Dumper::LOCATION_CLASS'),
            "logSeverity" => array(),
            "numLogEntries" => 10,
            "maxDepth" => 3,
            "maxLength" => 150,
            "showDebugBar" => array('frontend', 'backend'),
            "hideDebugBar" => null,
            "hideDebugBarTemplates" => array(),
            "hideDebugBarModals" => array('regularModal', 'inlineModal', 'overlayPanels', 'formBuilderIframe'),
            "frontendPanels" => array('processwireInfo', 'requestInfo', 'processwireLogs', 'tracyLogs', 'methodsInfo', 'debugMode', 'console', 'panelSelector', 'tracyToggler'),
            "backendPanels" => array('processwireInfo', 'requestInfo', 'processwireLogs', 'tracyLogs', 'methodsInfo', 'debugMode', 'console', 'panelSelector', 'tracyToggler'),
            "restrictedUserDisabledPanels" => array(),
            "showUserBar" => null,
            "showUserBarTracyUsers" => null,
            "userBarFeatures" => array('admin', 'editPage'),
            "userBarCustomFeatures" => '',
            "userBarBackgroundColor" => '',
            "userBarBackgroundOpacity" => 1,
            "userBarIconColor" => '#666666',
            "userBarTopBottom" => 'bottom',
            "userBarLeftRight" => 'left',
            "showPanelLabels" => null,
            "panelZindex" => 100,
            "styleWhere" => array(),
            "styleAdminElements" => "body::before {\n\tcontent: \"[type]\";\n\tbackground: [color];\n\tposition: fixed;\n\tleft: 0;\n\tbottom: 100%;\n\tcolor: #ffffff;\n\twidth: 100vh;\n\tpadding: 0;\n\ttext-align: center;\n\tfont-weight: 600;\n\ttext-transform: uppercase;\n\ttransform: rotate(90deg);\n\ttransform-origin: bottom left;\n\tz-index: 999999;\n\tfont-family: sans-serif;\n\tfont-size: 11px;\n\theight: 13px;\n\tline-height: 13px;\npointer-events: none;\n}\n",
            "styleAdminColors" => "\nlocal|#FF9933\n*.local|#FF9933\n*.dev|#FF9933\ndev.*|#FF9933\n*.test|#FF9933\nstaging.*|#8b0066\n*.com|#009900",
            "styleAdminType" => "default",
            "showPWInfoPanelIconLabels" => 1,
            "pWInfoPanelLinksNewTab" => null,
            "customPWInfoPanelLinks" => array(11, 16, 22, 21, 29, 30, 31, 304),
            "requestInfoPanelSections" => array('moduleSettings', 'templateSettings', 'fieldSettings', 'pageInfo', 'languageInfo', 'templateInfo', 'fieldsListValues', 'serverRequest', 'inputGet', 'inputPost', 'inputCookie', 'session', 'editLinks'),
            "processwireInfoPanelSections" => array('apiVariables', 'coreClasses', 'configData', 'versionsList', 'adminLinks', 'documentationLinks', 'gotoId', 'processWireWebsiteSearch'),
            "debugModePanelSections" => array('pagesLoaded', 'modulesLoaded', 'hooks', 'databaseQueries', 'selectorQueries', 'timers', 'user', 'cache', 'autoload'),
            "diagnosticsPanelSections" => array('filesystemFolders'),
            "snippetsPath" => 'templates',
            "todoIgnoreDirs" => 'git, svn, images, img, errors, sass-cache, node_modules',
            "todoScanModules" => null,
            "todoAllowedExtensions" => 'php, module, inc, txt, latte, html, htm, md, css, scss, less, js',
            "variablesShowPwObjects" => null,
            "alwaysShowDebugTools" => 1,
            "respectConfigDebugTools" => null,
            "userDevTemplate" => null,
            "userDevTemplateSuffix" => 'dev',
            "customPhpCode" => '',
            "email" => '',
            "clearEmailSent" => null,
            "referencePageEdited" => 1,
            "editor" => 'subl://open/?url=file://%file&line=%line',
            "useOnlineEditor" => array(),
            "onlineEditor" => 'tracy',
            "forceEditorLinksToTracy" => 1,
            "localRootPath" => '',
            "fileEditorAllowedExtensions" => 'php, module, js, css, htaccess',
            "fileEditorBaseDirectory" => 'templates',
            "enableShortcutMethods" => 1,
            "enabledShortcutMethods" => array('debugAll', 'da', 'dump', 'd', 'barDump', 'bd', 'barDumpBig', 'bdb', 'barDumpLive', 'bdl', 'l', 'timer', 't', 'fireLog', 'fl', 'addBreakpoint', 'bp', 'templateVars', 'tv')
        );
    }


    /**
     * Populate the default config data
     *
     */
    public static $_data;

    public function __construct() {
        foreach(self::getDefaultData() as $key => $value) {
            $this->$key = $value;
        }
        //populate for later static access to data
        self::$_data = $this;
    }


    /**
     * Initialize the module
     */
    public function init() {

        static::$isLocal = static::isLocal();

        // EARLY EXITS

        // if "enabled" not checked, we should load dummy Tracy class, TD, and shortcut methods
        // to prevent errors from debug statements still in code, and then exit before anything else
        if(!$this->data['enabled']) {
            // load dummy class to prevent "class not found" errors when calling \Tracy\Debugger::method() directly
            require_once __DIR__ . '/includes/DummyTracyDebuggerClass.php';

            // load main methods to prevent function not defined errors
            require_once __DIR__ . '/includes/TD.php';

            // load shortcut methods to prevent function not defined errors
            if($this->data['enableShortcutMethods']) {
                require_once __DIR__ . '/includes/ShortcutMethods.php';
            }
            return;
        }


        // url for $session->redirects
        $this->httpReferer = isset($_SERVER['HTTP_REFERER']) ? $this->wire('sanitizer')->text($_SERVER['HTTP_REFERER']) : self::inputHttpUrl(true);

        // determine if we are in the admin / backend
        static::$inAdmin = $this->inAdmin();


        // modals
        if(in_array('regularModal', $this->data['hideDebugBarModals']) && $this->wire('input')->get->modal == '1') return;
        if(in_array('inlineModal', $this->data['hideDebugBarModals']) && $this->wire('input')->get->modal == 'inline') return;
        if(in_array('overlayPanels', $this->data['hideDebugBarModals']) && $this->wire('input')->get->modal == 'panel') return;

        // formbuilder iframe
        if(in_array('formBuilderIframe', $this->data['hideDebugBarModals']) &&
            !static::$inAdmin &&
            strpos(self::inputUrl(true), DIRECTORY_SEPARATOR.'form-builder'.DIRECTORY_SEPARATOR) !== false)
                return;

        // don't init Tracy for @soma's PageEditSoftLock polling on Page Edit
        if(strpos(self::inputUrl(), 'checkpagelock') !== false) return;

        if(isset($_SERVER['REQUEST_URI'])) {
            $info = parse_url($_SERVER['REQUEST_URI']);
            $queryString = isset($info['query']) ? $info['query'] : '';
            // don't init Tracy for the PW Notifications module polling
            if(strpos($queryString, 'Notifications=update') !== false) return;

            // don't init Tracy for sidenav iframes in admin themes that support this
            if(strpos($queryString, 'layout=sidenav-side') !== false ||
                strpos($queryString, 'layout=sidenav-tree') !== false ||
                strpos($queryString, 'layout=sidenav-init') !== false) return;

            // don't init Tracy for Setup > Logs view polling
            if(strpos($_SERVER['REQUEST_URI'], DIRECTORY_SEPARATOR.'logs'.DIRECTORY_SEPARATOR.'view'.DIRECTORY_SEPARATOR) !== false &&
                strpos($queryString, 'q=') !== false) return;

        }


        // clear session & cookies option in Processwire Info panel
        // not inside $this->allowedTracyUsers() === 'development' check because it won't validate during forceLogin()
        if($this->wire('input')->get->tracyClearSession) {
            $userName = $this->wire('user')->name;
            $this->wire('session')->logout();

            if (isset($_SERVER['HTTP_COOKIE'])) {
                $cookies = explode(';', $_SERVER['HTTP_COOKIE']);
                foreach($cookies as $cookie) {
                    $parts = explode('=', $cookie);
                    $name = trim($parts[0]);
                    setcookie($name, '', time()-1000);
                    setcookie($name, '', time()-1000, '/');
                }
            }

            $this->wire('session')->forceLogin($userName);
            $this->wire('session')->redirect(substr(str_replace('tracyClearSession=1', '', self::inputUrl(true)), 0, -1));
        }


        // USER BAR
        if(
            $this->wire('user')->isLoggedin() &&
            !static::$inAdmin &&
            $this->data['showUserBar'] &&
            count($this->data['userBarFeatures'])>0 &&
            !$this->wire('config')->ajax &&
            ($this->allowedTracyUsers() !== 'development' || $this->data['showUserBarTracyUsers']) &&
            (strpos(self::inputUrl(true), DIRECTORY_SEPARATOR.'form-builder'.DIRECTORY_SEPARATOR) === false)
        ) {
            $this->addHookAfter('Page::render', $this, 'addUserBar', array('priority'=>1000));
        }


        // Various features that can be run before loading Tracy core files
        if($this->allowedTracyUsers() === 'development') {

            // PANELS TO DISPLAY
            $configEnabledPanels = static::$inAdmin ? $this->data['backendPanels'] : $this->data['frontendPanels'];

            // need to set $stickyPanels here so it is alway set if available, rather than in the elseif below
            // because a "once" cookie would prevent if from being set
            if($this->wire('input')->cookie->tracyPanelsSticky) {
                static::$stickyPanels = array_filter(explode(',', $this->wire('input')->cookie->tracyPanelsSticky));
            }

            if($this->wire('input')->cookie->tracyPanelsOnce) {
                static::$oncePanels = array_filter(explode(',', $this->wire('input')->cookie->tracyPanelsOnce));
                static::$showPanels = static::$oncePanels;
                unset($this->wire('input')->cookie->tracyPanelsOnce);
                setcookie("tracyPanelsOnce", "", time()-3600, '/');
            }
            elseif($this->wire('input')->cookie->tracyPanelsSticky) {
                static::$showPanels = static::$stickyPanels;
            }
            else {
                static::$showPanels = $configEnabledPanels;
            }

            if(in_array('debugMode', static::$showPanels)) {
                // Selectors for Debug Mode panel
                $this->addHookBefore('PageFinder::getQuery', null, function($event) {
                    $this->timerkey = Debug::timer();
                });
                $this->addHookAfter('PageFinder::getQuery', null, function($event) {
                    $event->setArgument(2, Debug::timer($this->timerkey));
                    static::$pageFinderQueries[] = $event;
                });
            }

            // sort panels based on order defined in config settings
            $showPanelsOrdered = array();
            $i=0;
            // add default panels in the defined order
            foreach($configEnabledPanels as $panelName) {
                if(in_array($panelName, static::$showPanels)) $showPanelsOrdered[$i] = $panelName;
                $i++;
            }
            // add once/sticky panels to the end because there is no specified order for these in config settings
            foreach(static::$allPanels as $panelName => $panelTitle) {
                if(in_array($panelName, static::$showPanels) && !in_array($panelName, $showPanelsOrdered)) $showPanelsOrdered[$i] = $panelName;
                // define disabled panels for restricted users
                if(($this->superuserHasPermission("tracy-restricted-panels") || $this->wire('user')->hasRole("tracy-restricted-panels")) && in_array($panelName, $this->data['restrictedUserDisabledPanels'])) {
                    static::$restrictedUserDisabledPanels[] = $panelName;
                }
                $i++;
            }
            // move Panel Selector to the end so it has access to the generation time values for all other panels
            static::$showPanels = $showPanelsOrdered;
            if(($key = array_search('panelSelector', static::$showPanels)) !== false) {
                unset(static::$showPanels[$key]);
                static::$showPanels[] = 'panelSelector';
            }


            // ProcessWire Info panel early redirects
            // logout
            if($this->wire('input')->get->tracyLogout) {
                $this->wire('session')->logout();
                $this->wire('session')->redirect(rtrim(substr(str_replace(array('tracyLogout=1', 'login=1'), '', self::inputUrl(true)), 0, -1), '?'));
            }
            // login
            if($this->wire('input')->get->tracyLogin) {
                $this->wire('session')->tracyLoginUrl = $this->httpReferer;
            }
            if($this->wire('session')->tracyLoginUrl) {
                $this->addHookAfter('Session::loginSuccess', function(HookEvent $event) {
                    $this->wire('session')->redirect($this->wire('session')->tracyLoginUrl);
                });
            }

            // refresh modules
            if($this->wire('input')->get->tracyModulesRefresh) {
                $this->wire('session')->tracyLastUrl = substr(str_replace('tracyModulesRefresh=1', '', self::inputUrl(true)), 0, -1);
                $this->wire('session')->redirect($this->wire('config')->urls->admin.'module/?reset=1');
            }
            if($this->wire('input')->get->reset == 2 && $this->wire('session')->tracyLastUrl) {
                $tracyLastUrl = $this->wire('session')->tracyLastUrl;
                $this->wire('session')->remove('tracyLastUrl');
                $this->wire('session')->redirect($tracyLastUrl);
            }


            // PW VERSION SWITCHER
            // if PW version changed, reload to initialize new version
            // don't add in_array(static::$showPanels) check because that won't be true if enabled ONCE due to multiple redirects waiting for $this->wire('config')->version to update
            if(($this->wire('input')->post->tracyPwVersion && $this->wire('input')->post->tracyPwVersion != $this->wire('config')->version) || $this->wire('session')->tracyPwVersion) {
                $this->wire('session')->tracyPwVersion = $this->wire('session')->tracyPwVersion ?: $this->wire('input')->post->tracyPwVersion;
                while($this->wire('session')->tracyPwVersion != $this->wire('config')->version) {
                    sleep(1);
                    $this->wire('session')->redirect($this->httpReferer . (strpos($this->httpReferer, '?') !== false ? '&' : '?') . 'tracyModulesRefresh=1');
                }
                $this->wire('session')->remove('tracyPwVersion');
            }


            // USER SWITCHER
            // process userSwitcher if panel open and switch initiated
            if(in_array('userSwitcher', static::$showPanels) && $this->wire('input')->post->userSwitcher) {
                // if user is superuser and session length is set, save to config settings
                if($this->wire('user')->isSuperuser() && $this->wire('input')->post->userSwitchSessionLength && $this->wire('session')->CSRF->validate()) {
                    // cleanup expired sessions
                    if(isset($this->data['userSwitchSession'])) {
                        foreach($this->data['userSwitchSession'] as $id => $expireTime) {
                            if($expireTime < time()) unset($this->data['userSwitchSession'][$id]);
                        }
                    }
                    // if no existing session ID, start a new session
                    if(!$this->wire('session')->tracyUserSwitcherId) {
                        $pass = new Password();
                        $challenge = $pass->randomBase64String(32);
                        $this->wire('session')->tracyUserSwitcherId = $challenge;
                    }
                    // save session ID and expiry time in module config settings
                    $this->data['userSwitchSession'][$this->wire('session')->tracyUserSwitcherId] = time() + ($this->wire('input')->post->userSwitchSessionLength * 60);
                    $this->wire('modules')->saveModuleConfigData('TracyDebugger', $this->data);
                }
                // if logout button clicked
                if($this->wire('input')->post->logoutUserSwitcher && $this->wire('session')->CSRF->validate()) {
                    if($this->wire('session')->tracyUserSwitcherId) {
                        // if session variable exists, grab it and add to the new session after logging out
                        $tracyUserSwitcherId = $this->wire('session')->tracyUserSwitcherId;
                        $this->wire('session')->logout();
                        $this->wire('session')->tracyUserSwitcherId = $tracyUserSwitcherId;
                    }
                    else {
                        $this->wire('session')->logout();
                    }
                    $this->wire('session')->redirect($this->httpReferer);
                }
                // if end session clicked, remove session variable and config settings entry
                elseif($this->wire('input')->post->endSessionUserSwitcher && $this->wire('session')->CSRF->validate()) {
                    $this->wire('session')->remove("tracyUserSwitcherId");
                    unset($this->data['userSwitchSession'][$this->wire('session')->tracyUserSwitcherId]);
                    $this->wire('modules')->saveModuleConfigData('TracyDebugger', $this->data);
                    $this->wire('session')->redirect($this->httpReferer);
                }
                // if session not expired, switch to requested user
                elseif($this->wire('input')->post->userSwitcher && $this->wire('session')->CSRF->validate()) {
                    if(isset($this->data['userSwitchSession'][$this->wire('session')->tracyUserSwitcherId]) && $this->data['userSwitchSession'][$this->wire('session')->tracyUserSwitcherId] > time() && $this->wire('session')->tracyUserSwitcherId) {
                        // if session variable exists, grab it and add to the new session after logging out
                        // and forceLogin the new switched user
                        $tracyUserSwitcherId = $this->wire('session')->tracyUserSwitcherId;
                        if($this->wire('user')->isLoggedin()) $this->wire('session')->logout();
                        $user = $this->wire('session')->forceLogin($this->wire('input')->post->userSwitcher);
                        $this->wire('session')->tracyUserSwitcherId = $tracyUserSwitcherId;
                    }
                    if($this->wire('pages')->get(self::inputUrl())->viewable) {
                        $this->wire('session')->redirect($this->httpReferer);
                    }
                    else {
                        $this->wire('session')->redirect(static::$inAdmin ? $this->wire('config')->urls->admin : $this->wire('config')->urls->root);
                    }
                }
            }


            // MODULES DISABLER
            //set up backup directory/file - outside conditional so they are available for cleanup when panel is disabled
            $this->tracyCacheDir = $this->wire('config')->paths->cache . 'TracyDebugger/';
            $this->modulesDbBackupFilename = 'modulesBackup.sql';
            if(in_array('moduleDisabler', static::$showPanels) && $this->wire('config')->debug && $this->wire('config')->advanced) {
                // if modules DB was just restored, clear the cookie
                if($this->wire('input')->cookie->modulesRestored == 1) {
                    unset($this->wire('input')->cookie->modulesRestored);
                    setcookie("modulesRestored", "", time()-3600, "/");
                    unset($this->wire('input')->cookie->tracyModulesDisabled);
                    setcookie("tracyModulesDisabled", "", time()-3600, "/");
                    $this->wire('session')->message("Modules successfully restored");
                }

                // get array of disabable modules
                foreach($this->wire('modules') as $name => $label) {
                    $flags = $this->wire('modules')->getFlags($name);
                    $info = $this->wire('modules')->getModuleInfoVerbose($name);
                    if($info['core']) continue;
                    if($name == 'TracyDebugger') continue;
                    if(($flags & Modules::flagsAutoload) || ($flags & Modules::flagsDisabled)) {
                        static::$disabableModules[] = $name;
                    }
                }

                // if modules have been checked to disable
                if($this->wire('input')->cookie->tracyModulesDisabled) {
                    if (!file_exists($this->tracyCacheDir)) wireMkdir($this->tracyCacheDir);

                    // if it doesn't already exist, backup existing modules database
                    if(!file_exists($this->tracyCacheDir . $this->modulesDbBackupFilename)) {
                        $backup = new WireDatabaseBackup($this->tracyCacheDir);
                        $backup->setDatabase($this->wire('database'));
                        $backup->setDatabaseConfig($this->wire('config'));
                        $file = $backup->backup(array('tables' => array('modules'), 'filename' => $this->modulesDbBackupFilename));

                        $restoreModulesCode =
                        "<?php\n" .
                        "if(file_exists('".$this->tracyCacheDir.$this->modulesDbBackupFilename."')) {\n" .
                            "\t\$db = new PDO('mysql:host={$this->wire('config')->dbHost};dbname={$this->wire('config')->dbName}', '{$this->wire('config')->dbUser}', '{$this->wire('config')->dbPass}');\n" .
                            "\t\$sql = file_get_contents('" . $this->tracyCacheDir . $this->modulesDbBackupFilename . "');\n" .
                            "\t\$qr = \$db->query(\$sql);\n" .
                        "}\n" .
                        "if(isset(\$qr) && \$qr) {\n" .
                            "\tsetcookie('modulesRestored', 1, time() + (24 * 60 * 60));\n" .
                            "\theader('Location: ".self::inputHttpUrl(true)."');\n" .
                        "}\n" .
                        "else {\n" .
                        "\techo 'Sorry, there was a problem and the database could not be restored.';\n" .
                        "}";

                        if(!file_put_contents($this->tracyCacheDir . 'restoremodules.php', $restoreModulesCode, LOCK_EX)) throw new WireException("Unable to write file: " . $this->tracyCacheDir . 'restoremodules.php');
                    }

                    // get array of modules that have been checked to disable
                    static::$disabledModules = array_filter(explode(',', $this->wire('input')->cookie->tracyModulesDisabled));
                }
                else {
                    $this->deleteFile($this->tracyCacheDir . $this->modulesDbBackupFilename);
                    $this->deleteFile($this->tracyCacheDir . 'restoremodules.php');
                }

                // add disabled flag to requested modules
                $i=0;
                foreach(static::$disabableModules as $name) {
                    $flags = $this->wire('modules')->getFlags($name);
                    if(in_array($name, static::$disabledModules)) {
                        if(!($flags & Modules::flagsDisabled)) {
                            $this->wire('modules')->setFlag($name, Modules::flagsDisabled, true);
                            $i++;
                        }
                    }
                    elseif($flags & Modules::flagsDisabled) {
                        $this->wire('modules')->setFlag($name, Modules::flagsDisabled, false);
                        $i++;
                    }
                }
                if($i > 0) $this->wire('session')->redirect($this->httpReferer);
            }
            else {
                $this->deleteFile($this->tracyCacheDir . $this->modulesDbBackupFilename);
                $this->deleteFile($this->tracyCacheDir . 'restoremodules.php');
            }
            // try to delete modules restore file from root
            $rootRestoreFile = $this->wire('config')->paths->root . 'restoremodules.php';
            if(file_exists($rootRestoreFile)) {
                @unlink($rootRestoreFile);
                if(is_file($rootRestoreFile)) {
                   $this->wire('session')->error('Please delete ' . $rootRestoreFile . ' from your system.');
                }
            }


            // PAGE RECORDER
            // trash / clear recorded pages if requested
            if($this->wire('input')->post->trashRecordedPages || $this->wire('input')->post->clearRecordedPages) {
                if($this->wire('input')->post->trashRecordedPages) {
                    foreach($this->data['recordedPages'] as $pid) {
                        $this->wire('pages')->trash($this->wire('pages')->get($pid));
                    }
                }
                unset($this->data['recordedPages']);
                $this->wire('modules')->saveModuleConfigData('TracyDebugger', $this->data);
                $this->wire('session')->redirect($this->httpReferer);
            }

        }

        // TRACY SETUP
        // load core tracy library
        if($this->allowedTracyUsers()) {
            static::$tracyVersion = $this->data['coreBranch'];
            /*if(!file_exists(__DIR__ . '/tracy-'.static::$tracyVersion.'/src/tracy.php')) {
                static::$tracyVersion = version_compare(phpversion(), '5.4.4', '>=') ? 'master' : 'legacy';
            }*/
            require_once __DIR__ . '/tracy-'.static::$tracyVersion.'/src/tracy.php';
        }
        else {
            // if user not allowed then load dummy class to prevent "class not found" errors when
            // calling \Tracy\Debugger::method() directly
            require_once __DIR__ . '/includes/DummyTracyDebuggerClass.php';
        }

        // always needs to be loaded to prevent function not defined errors when user not allowed to use Tracy
        require_once __DIR__ . '/includes/TD.php';

        // always needs to be loaded to prevent function not defined errors when user not allowed to use Tracy
        if($this->data['enableShortcutMethods']) {
            require_once __DIR__ . '/includes/ShortcutMethods.php';
        }


        // CONSOLE PANEL CODE INJECTION
        if($this->allowedTracyUsers() === 'development') {
            $this->insertCode('init');
            $this->addHookBefore('ProcessWire::finished', function($event) {
                $this->insertCode('finished');
            });
        }


        // START ENABLING TRACY
        // now that required classes above have been loaded if requested,
        // we can now exit if user not allowed
        if(!$this->allowedTracyUsers()) return;


        // SET TRACY AS ENBALED
        // if we get this far, Tracy is fully enabled, so set this for checking in ready()
        $this->tracyEnabled = true;


        // TRACY LOGS
        // Tracy log folder path
        $logFolder = $this->wire('config')->paths->logs.'tracy';

        // delete Tracy logs if requested
        if($this->wire('input')->post->deleteTracyLogs) {
            wireRmdir($logFolder, true);
        }

        // if Tracy log folder doesn't exist, create it now
        if(!is_dir($logFolder)) wireMkdir($logFolder);


        // TRACY MODE
        if($this->data['outputMode'] == 'development' || $this->allowedTracyUsers() === 'development') {
            $outputMode = Debugger::DEVELOPMENT;
        }
        elseif($this->data['outputMode'] == 'production' || $this->allowedTracyUsers() === 'production') {
            $outputMode = Debugger::PRODUCTION;
        }
        else {
            $outputMode = Debugger::DETECT;
        }

        // back-end
        if(static::$inAdmin) {
            if(in_array('backend', $this->data['showDebugBar']) && $outputMode != Debugger::PRODUCTION) {
                Debugger::$showBar = true;
            }
            else {
                Debugger::$showBar = false;
            }
        }
        // front-end
        else {
            if(in_array('frontend', $this->data['showDebugBar']) && $outputMode != Debugger::PRODUCTION) {
                Debugger::$showBar = true;
            }
            else {
                Debugger::$showBar = false;
            }
        }


        if($this->allowedTracyUsers() === 'development') {

            // TRACY TOGGLER
            // if Tracy has been toggled "disabled" add enable button and then exit
            if($this->wire('input')->cookie->tracyDisabled == 1) {
                if(Debugger::$showBar && !$this->wire('config')->ajax) {
                    $this->addHookAfter('Page::render', $this, 'addEnableButton', array('priority'=>1000));
                }
                // Tracy not enabled so exit now
                $this->tracyEnabled = false;
                return;
            }


            if(Debugger::$showBar) {

                // EDITOR PROTOCOL HANDLER
                // build up array of replacements to pass to Debugger::$editorMapping
                // they have to be completely separate replacements because Tracy uses strtr()
                // which won't replace the same substring more than once
                $mappingReplacements = array();
                $compilerCachePath = isset($this->wire('config')->fileCompilerOptions['cachePath']) ? $this->wire('config')->fileCompilerOptions['cachePath'] : $this->wire('config')->paths->cache . 'FileCompiler/';
                $compilerCachePath = str_replace('/', DIRECTORY_SEPARATOR, $compilerCachePath);

                static::$useOnlineEditor = $this->wire('user')->isSuperuser() &&
                    (static::$isLocal && in_array('local', $this->data['useOnlineEditor'])) ||
                    (!static::$isLocal && in_array('live', $this->data['useOnlineEditor']) ||
                    (in_array('fileEditor', static::$showPanels) && $this->data['forceEditorLinksToTracy'])
                );

                if(static::$useOnlineEditor) {
                    if($this->data['onlineEditor'] == 'processFileEdit' &&
                        $this->wire('modules')->isInstalled('ProcessFileEdit') &&
                        $this->wire('user')->hasPermission('file-edit'))
                    {
                        static::$onlineEditor = 'processFileEdit';
                        Debugger::$editor = $this->wire('config')->urls->admin . 'setup/file-editor/?f=%file&l=%line';
                        $processFileEditSettings = $this->wire('modules')->getModuleConfigData('ProcessFileEdit');
                        static::$onlineFileEditorDirPath = $processFileEditSettings['dirPath'];
                    }
                    else {
                        static::$onlineEditor = 'tracy';
                        Debugger::$editor = 'tracy://?f=%file&l=%line';
                        static::$onlineFileEditorDirPath = $this->wire('config')->paths->root;
                    }
                    $mappingReplacements[$compilerCachePath . str_replace($this->wire('config')->paths->root,'' , static::$onlineFileEditorDirPath)] = '';
                    $mappingReplacements[static::$onlineFileEditorDirPath] = '';
                }
                else {
                    Debugger::$editor = $this->data['editor'];

                    if(!static::$isLocal && $this->data['localRootPath'] != '') {
                        $mappingReplacements[$compilerCachePath] = $this->data['localRootPath'];
                        $mappingReplacements[$this->wire('config')->paths->root] = $this->data['localRootPath'];
                    }
                    else {
                        $mappingReplacements[$compilerCachePath] = $this->wire('config')->paths->root;
                    }
                }

                Debugger::$editorMapping = $mappingReplacements;


                //CUSTOM CSS & JS
                Debugger::$customCssFiles = array(
                    $this->wire('config')->paths->TracyDebugger.'styles.css'
                );

                if(in_array('fileEditor', static::$showPanels)) {
                    // these need to be loaded here (not just in File Editor panel) so that File Editor links
                    // will work even if File Editor panel hasn't been opened yet
                    Debugger::$customJsFiles[] = $this->wire('config')->paths->TracyDebugger.'scripts/js-loader.js';
                    Debugger::$customJsFiles[] = $this->wire('config')->paths->TracyDebugger.'scripts/file-editor.js';
                }

                if($this->showServerTypeIndicator()) Debugger::$customCssStr .= $this->setServerAdminStyleColor();

                if(!static::$inAdmin && (in_array('fileEditor', static::$showPanels) || (in_array('processwireInfo', static::$showPanels) && count($this->data['customPWInfoPanelLinks'])))) {
                    Debugger::$customCssStr .= '<link id="fontAwesomeStyles" type="text/css" href="'.$this->wire('config')->urls->root . 'wire/templates-admin/styles/font-awesome/css/font-awesome.min.css" rel="stylesheet" />';
                }

                // override Tracy core default zIndex for panels
                // add settings link on double-click to "TRACY" icon
                // replace "close" icon link with "hide" and "unhide" links
                $this->addHookAfter('Page::render', function($event) {
                    $tracyErrors = Debugger::getBar()->getPanel('Tracy:errors');
                    if(!is_array($tracyErrors->data) || count($tracyErrors->data) === 0) {
                        if(($this->data['hideDebugBar'] && !$this->wire('input')->cookie->tracyShow) || $this->wire('input')->cookie->tracyHidden == 1) {
                            $hideBar = '
                                <script>
                                    function hideDebugBar() {
                                        if(!document.getElementById("tracy-debug-bar")) {
                                            window.requestAnimationFrame(hideDebugBar);
                                        } else {
                                            document.getElementById("tracy-debug").style.display = "none";
                                            document.getElementById("tracy-show-button").style.display = "block";
                                        }
                                    }
                                    hideDebugBar();
                                </script>
                            ';
                            $event->return = str_replace("</body>", "\n<!-- Tracy Hide Bar -->\n" . static::minify($hideBar)."\n</body>", $event->return);
                        }
                    }
                });

                Debugger::$customBodyStr .= '
                    <div id="tracy-show-button" title="Show Tracy" onclick="unhideBar()">&#8689;</div>
                ';

                Debugger::$customJsStr .= '
                    function addHideLink() {
                        if(!document.getElementById("tracy-debug-bar")) {
                            window.requestAnimationFrame(addHideLink);
                        } else {
                            var debugBar = document.getElementById("tracy-debug-bar");
                            var barul = debugBar.getElementsByTagName("ul")[0];
                            var toggleli = document.createElement("li");
                            toggleli.appendChild(document.createTextNode("â‡²"));
                            toggleli.setAttribute("id", "hide-button");
                            toggleli.setAttribute("title", "Hide Tracy");
                            toggleli.addEventListener("click", function() {
                                document.getElementById("tracy-debug").style.display = "none";
                                document.getElementById("tracy-show-button").style.display = "block";
                                document.cookie = "tracyHidden=1; path=/";
                                document.cookie = "tracyShow=; expires=Thu, 01 Jan 1970 00:00:01 GMT; path=/";';
                                if($this->showServerTypeIndicator() && $this->data['styleAdminType'] == 'custom') {
                                    Debugger::$customJsStr .= 'document.body.classList.add("tracyHidden");';
                                }
                            Debugger::$customJsStr .= '
                            });
                            barul.appendChild(toggleli);
                            barul.removeChild(barul.lastChild.previousElementSibling);
                        }
                    }
                    addHideLink();

                    function unhideBar() {
                        document.getElementById("tracy-debug").style.display = "block";
                        document.getElementById("tracy-show-button").style.display = "none";
                        document.cookie = "tracyHidden=; expires=Thu, 01 Jan 1970 00:00:01 GMT; path=/";
                        document.cookie = "tracyShow=1; path=/";';
                        if($this->showServerTypeIndicator() && $this->data['styleAdminType'] == 'custom') {
                            Debugger::$customJsStr .= 'document.body.classList.remove("tracyHidden");';
                        }
                    Debugger::$customJsStr .= '
                    }

                    function modifyTracyLogo() {
                        if(!document.getElementById("tracy-debug-bar")) {
                            window.requestAnimationFrame(modifyTracyLogo);
                        } else {
                            var tracyLogo = document.getElementById("tracy-debug-logo");
                            tracyLogo.setAttribute("title", tracyLogo.getAttribute("title") + "\n\nDouble-click to visit module settings");
                            tracyLogo.addEventListener("dblclick", function() {
                                window.open("'.$this->wire('config')->urls->admin.'module/edit?name=TracyDebugger","_blank");
                            }, false);
                        }
                    }
                    modifyTracyLogo();


                    function bsZIndex() {
                        if(!document.getElementById("tracy-bs")) {
                            window.requestAnimationFrame(bsZIndex);
                        } else {
                            if(document.getElementById("tracy-bs"))
                                document.getElementById("tracy-bs").style.zIndex = z = '.$this->data['panelZindex'].';
                        }
                    }
                    bsZIndex();

                    function panelsZIndex() {
                        if(!document.getElementById("tracy-debug-bar")) {
                            window.requestAnimationFrame(panelsZIndex);
                        } else {
                            window.Tracy.DebugPanel.zIndex = z = '.$this->data['panelZindex'].';
                            var panels = document.getElementsByClassName("tracy-panel");
                            if(panels.length > 0) {
                                for (var i = 0; i < panels.length; i++) {
                                    panels[i].style.zIndex = z++;
                                }
                            }
                        }
                    }
                    panelsZIndex();
                ';

                if($this->data['hideDebugBar'] && $this->showServerTypeIndicator() && $this->data['styleAdminType'] == 'custom' && !$this->wire('input')->cookie->tracyShow) {
                    // hide server type indicator bar if debug bar is hidden by default
                    Debugger::$customJsStr .= 'document.body.classList.add("tracyHidden");';
                }

                // remove localStorage items to prevent the panel from staying open
                Debugger::$customJsStr .= '
                    localStorage.removeItem("tracy-debug-panel-PanelSelectorPanel");
                    if(localStorage.getItem("remove-tracy-debug-panel-ProcesswireInfoPanel")) {
                        localStorage.removeItem("tracy-debug-panel-ProcesswireInfoPanel");
                        localStorage.removeItem("remove-tracy-debug-panel-ProcesswireInfoPanel")
                    }
                ';

                if(is_null($this->wire('session')->tracyDumpsRecorderItems)) {
                    // remove localStorage items to prevent the panel from staying open
                    Debugger::$customJsStr .= '
                        localStorage.removeItem("tracy-debug-panel-DumpsRecorderPanel");
                    ';
                }

            }


            // MAIL INTERCEPTOR
            // if mail panel items were cleared, clear them from the session variable
            if($this->wire('input')->post->tracyClearMailItems || (!in_array('mailInterceptor', static::$showPanels) && $this->wire('session')->tracyMailItems)) {
                $this->wire('session')->tracyMailItems = null;
                $this->wire('session')->redirect($this->httpReferer);
            }
            // mail panel intercept hook
            if(in_array('mailInterceptor', static::$showPanels)) {
                $this->addHookBefore('WireMail::send', $this, 'interceptEmails');
            }

            // CAPTAIN HOOK
            // update cache on module install
            // not wrapped in: if(in_array('captainHook', static::$showPanels)) because this wouldn't work for "once" enabled
            $this->addHookAfter('Modules::install', $this, 'deleteHookCache');
            $this->addHookAfter('Modules::uninstall', $this, 'deleteHookCache');
            $this->addHookAfter('Modules::refresh', $this, 'deleteHookCache');
            $this->addHookAfter('Modules::moduleVersionChanged', $this, 'deleteHookCache');
            $this->addHookAfter('SystemUpdater::coreVersionChange', $this, 'deleteHookCache');


            if(!static::$inAdmin) {
                // VALIDATOR
                if(in_array('validator', static::$showPanels)) {
                    $this->addHookAfter('Page::render', $this, 'getPageHtml', array('priority'=>1000));
                }

                // TEMPLATE RESOURCES
                if(!$this->wire('config')->ajax && (in_array('console', static::$showPanels) || in_array('templateResources', static::$showPanels))) {
                    $functions = get_defined_functions();
                    \TracyDebugger::$initialFuncs = $functions['user'];
                    \TracyDebugger::$initialConsts = get_defined_constants();
                    $this->addHookBefore('TemplateFile::render', function($event) {
                        $event->object->setAppendFilename(__DIR__ . '/includes/GetTemplateResources.php');
                    });
                }
            }


            // EVENT INTERCEPTOR
            // if event interceptor panel items were cleared, clear them from the session variable and remove cookie
            if($this->wire('input')->cookie->tracyClearEventItems || (!in_array('eventInterceptor', static::$showPanels) && $this->wire('session')->tracyEventItems)) {
                $this->wire('session')->tracyEventItems = null;
                unset($this->wire('input')->cookie->tracyClearEventItems);
                setcookie("tracyClearEventItems", "", time()-3600, "/");
            }
            // event interceptor hook
            if(in_array('eventInterceptor', static::$showPanels) && $this->wire('input')->cookie->eventInterceptorHook) {
                $this->hookSettings = json_decode($this->wire('input')->cookie->eventInterceptorHook, true);
                if($this->hookSettings['when'] == 'before') {
                    $this->addHookBefore($this->hookSettings['hook'], $this, 'interceptEvent');
                }
                else {
                    $this->addHookAfter($this->hookSettings['hook'], $this, 'interceptEvent');
                }
            }


            // DUMPS
            // clear ajax items from session on window unload (javascript set cookie in Dumps panel)
            if($this->wire('input')->cookie->tracyClearDumpItemsAjax) {
                $this->wire('session')->remove('tracyDumpItemsAjax');
                unset($this->wire('input')->cookie->tracyClearDumpItemsAjax);
                setcookie("tracyClearDumpItemsAjax", "", time()-3600, "/");
            }


            // DUMPS RECORDER
            // if dump recorder panel items were cleared, clear them from the session variable and remove cookie
            if($this->wire('input')->cookie->tracyClearDumpsRecorderItems || !in_array('dumpsRecorder', static::$showPanels)) {
                $this->wire('session')->remove('tracyDumpsRecorderItems');
                unset($this->wire('input')->cookie->tracyClearDumpsRecorderItems);
                setcookie("tracyClearDumpsRecorderItems", "", time()-3600, "/");
            }


            // PAGE RECORDER
            // page recorder hook
            if(in_array('pageRecorder', static::$showPanels)) {
                $this->addHookAfter('Pages::added', $this, 'recordPage');
            }


            // TRACY SETTINGS
            //convert checked location strings to constants and array_reduce to bitwise OR (|) line
            $locations = array_map('constant', $this->data['showLocation']);
            Debugger::$showLocation = array_reduce($locations, function($a, $b) { return $a | $b; }, 0);

            //convert checked log severity strings to constants and array_reduce to bitwise OR (|) line
            $severityOptions = array_map('constant', $this->data['logSeverity']);
            Debugger::$logSeverity = array_reduce($severityOptions, function($a, $b) { return $a | $b; }, 0);

            Debugger::$maxDepth = $this->data['maxDepth'];
            if(property_exists('Debugger', 'maxLength')) {
                Debugger::$maxLength = $this->data['maxLength'];
            }
            else {
                // backwards compatibility with older versions of Tracy core before
                // https://github.com/nette/tracy/commit/12d5cafa9264f2dfc3dfccb302a0eea404dcc24e
                Debugger::$maxLen = $this->data['maxLength'];
            }
            Debugger::getFireLogger()->maxDepth = $this->data['maxDepth'];
            Debugger::getFireLogger()->maxLength = $this->data['maxLength'];
            Debugger::getBlueScreen()->maxDepth = $this->data['maxDepth'];
            Debugger::getBlueScreen()->maxLength = $this->data['maxLength'];

            Debugger::$strictMode = $this->data['strictMode'] || ($this->data['strictModeAjax'] && $this->wire('config')->ajax) || $this->wire('input')->cookie->tracyStrictMode ? TRUE : FALSE;
            Debugger::$scream = $this->data['forceScream'] ? TRUE : FALSE;


        }


        // ENABLE TRACY
        Debugger::enable($outputMode, $logFolder, $this->data['email'] != '' ? $this->data['email'] : null);

        // fixes for when SessionHandlerDB module is installed
        if($this->wire('modules')->isInstalled('SessionHandlerDB') && Debugger::$showBar) {

            // ensure Tracy can show additional bars when SessionHandlerDB module is installed and debugbar is showing
            $this->addHookBefore('ProcessWire::finished', $this, 'sessionHandlerDBAjaxFix');

            // ensure Tracy can show Redirect bars when SessionHandlerDB module is installed and debugbar is showing
            if(!$this->wire('config')->disableTracySHDBRedirectFix) {
                $this->addHookBefore('Session::redirect', function($event) {
                    $url = $event->arguments[0];
                    $http301 = isset($event->arguments[1]) ? $event->arguments[1] : true;
                    if($http301) header("HTTP/1.1 301 Moved Permanently");
                    header("Location: $url");
                });
            }
        }


    }


    /**
     * Called when ProcessWire's API is ready
     */
    public function ready() {

        // Exit now if "enabled" not true from init()
        if(!$this->tracyEnabled) return;


        // USER BAR PAGE VERSIONS
        if(!static::$inAdmin && $this->wire('user')->hasPermission('tracy-page-versions') && $this->data['showUserBar'] && in_array('pageVersions', $this->data['userBarFeatures']) && !$this->wire('config')->ajax && $this->wire('user')->isLoggedin()) {
            static::$pageVersion = $this->findPageTemplateInCookie($this->wire('input')->cookie->tracyPageVersion);
            if(static::$pageVersion && static::$pageVersion != pathinfo($this->wire('page')->template->filename, PATHINFO_BASENAME)) {
                static::$templatePath = static::$pageVersion;
                unset($this->wire('input')->cookie->tracyPageVersion);
                setcookie("tracyPageVersion", "", time()-3600, "/");
            }
            elseif(static::$pageVersion != '') {
                // don't change as already set by dev template permission functionality
            }
            else {
                static::$templatePath = '';
            }

            if(static::$templatePath != '') {
                $this->wire('page')->template->filename = static::$templatePath;
            }
        }


        // USER DEV TEMPLATES
        // if user dev template enabled and required permission exists in system,
        // check if current user has a matching permission for the current page's template
        $templateExt = pathinfo($this->wire('page')->template->filename, PATHINFO_EXTENSION);
        if($this->data['userDevTemplate'] && $this->wire('permissions')->get("tracy-".$this->wire('page')->template->name."-".$this->data['userDevTemplateSuffix'])->id) {
            $devTemplateFilename = str_replace('.'.$templateExt, '-'.$this->data['userDevTemplateSuffix'].'.'.$templateExt, $this->wire('page')->template->filename);
            if(file_exists($devTemplateFilename) && $this->superuserHasPermission("tracy-".$this->wire('page')->template->name."-".$this->data['userDevTemplateSuffix'])) {
                $this->wire('page')->template->filename = static::$templatePath = static::$templatePathPermission = $devTemplateFilename;
            }
        }


        if($this->allowedTracyUsers() === 'development') {

            // if it's an ajax request for the File Editor feature
            if($this->wire('config')->ajax && isset($this->wire('input')->post->filePath)) {
                require_once(__DIR__ . '/includes/GetFileDetails.php');
                return;
            }

            // if it's an ajax request from the ProcessWire Info GoTo Page ID feature
            if($this->wire('config')->ajax && isset($this->wire('input')->post->goToPage)) {
                require_once(__DIR__ . '/includes/GetPageById.php');
                return;
            }

            // CONSOLE PANEL CODE INJECTION
            $this->insertCode('ready');


            // FILE/TEMPLATE EDITOR
            if($this->wire('user')->isSuperuser()) {
                if($this->wire('input')->post->fileEditorFilePath) {
                    $rawCode = base64_decode($this->wire('input')->post->tracyFileEditorRawCode);
                    if(static::$inAdmin &&
                        \TracyDebugger::getDataValue('referencePageEdited') &&
                        $this->wire('input')->get('id') &&
                        $this->wire('pages')->get($this->wire('input')->get('id'))->template->filename === $this->wire('config')->paths->root . $this->wire('input')->post->fileEditorFilePath
                    ) {
                        $p = $this->wire('pages')->get($this->wire('input')->get('id'));
                    }
                    else {
                        $p = $this->wire('page');
                    }

                    $templateExt = pathinfo($p->template->filename, PATHINFO_EXTENSION);
                    $this->tempTemplateFilename = str_replace('.'.$templateExt, '-tracytemp.'.$templateExt, $p->template->filename);
                    // if changes to the template of the current page are submitted
                    // test
                    if($this->wire('input')->post->tracyTestTemplateCode) {
                        if(!file_put_contents($this->tempTemplateFilename, $rawCode, LOCK_EX)) throw new WireException("Unable to write file: " . $this->tempTemplateFilename);
                        if($this->wire('config')->chmodFile) chmod($this->tempTemplateFilename, octdec($this->wire('config')->chmodFile));
                        $p->template->filename = $this->tempTemplateFilename;
                    }

                    // if changes to any other file are submitted
                    if($this->wire('input')->post->tracyTestFileCode || $this->wire('input')->post->tracySaveFileCode || $this->wire('input')->post->tracyChangeTemplateCode) {
                        if($this->wire('input')->post->fileEditorFilePath != '' && strpos($this->wire('input')->post->fileEditorFilePath, '..') === false) {
                            $filePath = $this->wire('config')->paths->root . $this->wire('input')->post->fileEditorFilePath;
                            $rawCode = base64_decode($this->wire('input')->post->tracyFileEditorRawCode);

                            // backup old version to Tracy cache directory
                            $cachePath = $this->wire('config')->paths->cache . 'TracyDebugger/' . $this->wire('input')->post->fileEditorFilePath;
                            if(!is_dir($cachePath)) if(!wireMkdir(pathinfo($cachePath, PATHINFO_DIRNAME), true)) {
                                throw new WireException("Unable to create cache path: $cachePath");
                            }
                            copy($filePath, $cachePath);

                            if(!file_put_contents($filePath, $rawCode, LOCK_EX)) throw new WireException("Unable to write file: " . $filePath);
                            if($this->wire('config')->chmodFile) chmod($filePath, octdec($this->wire('config')->chmodFile));

                            if($this->wire('input')->post->tracyTestFileCode) setcookie('tracyTestFileEditor', $this->wire('input')->post->fileEditorFilePath, time() + (10 * 365 * 24 * 60 * 60), '/');
                        }
                        $this->wire('session')->redirect($this->httpReferer);
                    }
                }

                // if file editor restore
                if($this->wire('input')->post->tracyRestoreFileEditorBackup) {
                    $this->filePath = $this->wire('config')->paths->root . ($this->wire('input')->post->fileEditorFilePath ?: $this->wire('input')->cookie->tracyTestFileEditor);
                    $this->cachePath = $this->wire('config')->paths->cache . 'TracyDebugger/' . ($this->wire('input')->post->fileEditorFilePath ?: $this->wire('input')->cookie->tracyTestFileEditor);
                    copy($this->cachePath, $this->filePath);
                    unlink($this->cachePath);
                    $this->wire('session')->redirect($this->httpReferer);
                }
            }


            // DEBUG BAR & PANELS

            // hide debug bar from specified templates
            if(count($this->data['hideDebugBarTemplates']) > 0) {
                if($this->wire('page')->id && in_array($this->wire('page')->template->id, $this->data['hideDebugBarTemplates'])) Debugger::$showBar = false;
            }

        }


        // exit now if not showing debug bar or user doesn't have 'development' access
        if(Debugger::$showBar == false || $this->allowedTracyUsers() !== 'development') return;

        // load base panel class
        require_once __DIR__ . '/includes/BasePanel.php';


        // load File Editor panel if Tracy online editor is selected
        if(static::$useOnlineEditor && static::$onlineEditor == 'tracy' && !in_array('fileEditor', static::$showPanels)) {
            array_push(static::$showPanels, 'fileEditor');
        }


        // LOAD SPECIFIED PANELS
        foreach(static::$showPanels as $panel) {
            if(static::$inAdmin && in_array($panel, static::$hideInAdmin)) continue;
            if(($panel == 'console' || $panel == 'snippetRunner' || $panel == 'fileEditor') && !$this->wire('user')->isSuperuser()) continue;
            if($panel == 'userSwitcher') {
                if(isset($this->data['userSwitchSession'])) $userSwitchSession = $this->data['userSwitchSession'];
                if(!$this->wire('user')->isSuperuser() && (!$this->wire('session')->tracyUserSwitcherId || (isset($userSwitchSession[$this->wire('session')->tracyUserSwitcherId]) && $userSwitchSession[$this->wire('session')->tracyUserSwitcherId] <= time()))) continue;
            }
            // ignore disabled panels for restricted users
            if(!empty(static::$restrictedUserDisabledPanels) && in_array($panel, static::$restrictedUserDisabledPanels)) continue;

            $panelName = ucfirst($panel).'Panel';

            switch($panel) {
                case 'performance':
                    require_once __DIR__ . '/panels/'.$panelName.'.php';
                    break;
                case 'captainHook':
                case 'console':
                case 'customPhp':
                case 'debugMode':
                case 'diagnostics':
                case 'dumpsRecorder':
                case 'eventInterceptor':
                case 'fileEditor':
                case 'gitInfo':
                case 'mailInterceptor':
                case 'methodsInfo':
                case 'moduleDisabler':
                case 'outputMode':
                case 'pageRecorder':
                case 'panelSelector':
                case 'phpInfo':
                case 'processwireInfo':
                case 'processwireLogs':
                case 'processwireVersion':
                case 'requestInfo':
                case 'snippetRunner':
                case 'templateResources':
                case 'todo':
                case 'tracyLogs':
                case 'tracyToggler':
                case 'users':
                case 'userSwitcher':
                case 'validator':
                    require_once __DIR__ . '/panels/'.$panelName.'.php';
                    Debugger::getBar()->addPanel(new $panelName);
                    break;
                case 'templatePath':
                    require_once __DIR__ . '/panels/'.$panelName.'.php';
                    static::$templatePathOnce = $this->findPageTemplateInCookie($this->wire('input')->cookie->tracyTemplatePathOnce);
                    static::$templatePathSticky = $this->findPageTemplateInCookie($this->wire('input')->cookie->tracyTemplatePathSticky);
                    if(static::$templatePathOnce) {
                        static::$templatePath = static::$templatePathOnce;
                        unset($this->wire('input')->cookie->tracyTemplatePathOnce);
                        setcookie("tracyTemplatePathOnce", "", time()-3600, "/");
                    }
                    elseif(static::$templatePathSticky) {
                        static::$templatePath = static::$templatePathSticky;
                    }
                    elseif(static::$templatePath != '') {
                        // don't change as already set by dev template permission functionality
                    }
                    else {
                        static::$templatePath = '';
                    }

                    if(static::$templatePath != '') {
                        $this->wire('page')->template->filename = static::$templatePath;
                    }
                    Debugger::getBar()->addPanel(new $panelName);
                    break;
            }
        }
        // load custom replacement Dumps panel - this is not optional/configurable
        // at the end so it has access to bd() calls in any of the other panels - helpful for debugging these panels
        $panelName = 'DumpsPanel';
        require_once __DIR__ . '/panels/'.$panelName.'.php';
        Debugger::getBar()->addPanel(new $panelName);


        // CONSOLE & SNIPPETS RUNNER PANELS
        // if it's an ajax request from the Tracy Console or Snippet Runner panels for code execution, then process and return
        if($this->wire('config')->ajax && ($this->wire('input')->post->tracyConsole == 1 || $this->wire('input')->post->tracySnippetRunner == 1)) {
            require_once(__DIR__ . '/includes/CodeProcessor.php');
            return;
        }

        // if it's an ajax request from the Tracy Console panel snippets, then process and return
        if($this->wire('config')->ajax && $this->wire('input')->post->tracysnippets == 1) {
            require_once(__DIR__ . '/includes/ConsoleSnippets.php');
            return;
        }

    }


    /**
     * FUNCTIONS CALLED FROM HOOKS
     */


    /**
     * Hook after Page::render()
     *
     * Add the User bar
     *
     * @param HookEvent $event
     *
     */
    protected function addUserBar($event) {
        $userBar = '';
        require_once __DIR__ . '/includes/user-bar/UserBar.php';
        $event->return = str_replace("</body>", "\n<!-- Tracy User Bar -->\n" . static::minify($userBar)."\n</body>", $event->return);
    }


    /**
     * Hook after Page::render()
     *
     * Adds Enable button to page if the Tracy Toggler has currently disabled it
     *
     * @param HookEvent $event
     *
     */
    protected function addEnableButton($event) {
        // DON'T add comments to injected code below because it breaks my simple minify() function
        // if Tracy temporarily toggled disabled, add enable icon link
        $enableButton = '
        <style>
            div#TracyEnableButton {
                bottom: 10px !important;
                right: 10px !important;
                z-index: 99999 !important;
                position: fixed !important;
                width: 16px !important;
                height: 16px !important;
                margin: 0px !important;
                padding: 0px !important;
                cursor:pointer !important;
            }
            div#TracyEnableButton svg {
                width: 16px !important;
                height: 16px !important;
            }
        </style>
        <script>
            function enableTracy() {
                document.cookie = "tracyDisabled=; expires=Thu, 01 Jan 1970 00:00:01 GMT; path=/";
                location.reload();
            }
        </script>
        <div id="TracyEnableButton" title="Enable Tracy" onclick="enableTracy()">
            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" width="16px" height="16px" viewBox="0 0 44.816 44.816" style="enable-background:new 0 0 44.816 44.816;" xml:space="preserve">
                <g>
                    <path d="M22.404,21.173c2.126,0,3.895-1.724,3.895-3.85V3.849C26.299,1.724,24.53,0,22.404,0c-2.126,0-3.895,1.724-3.895,3.849    v13.475C18.51,19.449,20.278,21.173,22.404,21.173z" fill="#CD1818"/>
                    <path d="M30.727,3.33c-0.481-0.2-1.03-0.147-1.466,0.142c-0.434,0.289-0.695,0.776-0.695,1.298v5.113    c0,0.56,0.301,1.076,0.784,1.354c4.192,2.407,6.918,6.884,6.918,11.999c0,7.654-6.217,13.882-13.87,13.882    c-7.654,0-13.86-6.228-13.86-13.882c0-5.113,2.813-9.589,6.931-11.997c0.478-0.279,0.773-0.794,0.773-1.348V4.769    c0-0.521-0.261-1.009-0.695-1.298c-0.435-0.29-0.984-0.342-1.466-0.142C6.257,6.593,0.845,14.276,0.845,23.236    c0,11.92,9.653,21.58,21.572,21.58c11.917,0,21.555-9.66,21.555-21.58C43.971,14.276,38.554,6.593,30.727,3.33z" fill="#CD1818"/>
                </g>
            </svg>
        </div>';

        $event->return =  str_replace("</body>", "\n<!-- Tracy Enable Button -->\n" . static::minify($enableButton)."\n</body>", $event->return);

    }


    /**
     * Hook after Page::render()
     *
     * Gets the HTML of the page for the Validator Panel
     *
     * @param HookEvent $event
     *
     */
    protected function getPageHtml($event) {
        static::$pageHtml = $event->return;
    }


    /**
     * Hook before WireMail::send
     *
     * Intercepts outgoing emails for the Mail Interceptor Panel
     *
     * @param HookEvent $event
     *
     */
    protected function interceptEmails($event) {
        $mailItem = array();
        $mailItems = $this->wire('session')->tracyMailItems ? $this->wire('session')->tracyMailItems : array();
        foreach(array('subject', 'from', 'fromName', 'to', 'toName', 'cc', 'ccName', 'bcc', 'body', 'bodyHTML', 'attachments', 'header', 'priority', 'dispositionNotification', 'addSignature', 'sendSingle', 'sendBulk', 'useSentLog', 'wrapText', 'default_charset', 'sender_signature', 'sender_signature_html') as $param) {
            $mailItem[$param] = $event->object->$param;
        }
        $mailItem['timestamp'] = time();
        array_unshift($mailItems, $mailItem);
        $this->wire('session')->tracyMailItems = $mailItems;
        $event->replace = true;
        $event->return = true;
    }


    /**
     * Hook after Module::install
     *
     * Delete the existing Captain Hook cache when installing a module
     *
     * @param HookEvent $event
     *
     */
    protected function deleteHookCache($event) {
        $this->wire('cache')->delete('TracyCaptainHook');
    }


    /**
     * Hook before various
     *
     * Intercepts calls to defined hook and dumps result to Dumps Panel
     *
     * @param HookEvent $event
     *
     */
    // for the event interceptor panel
    protected function interceptEvent($event) {
        $eventItem = array();
        $eventItems = $this->wire('session')->tracyEventItems ? $this->wire('session')->tracyEventItems : array();
        $eventItem['timestamp'] = time();
        $options = array();
        $options[Dumper::COLLAPSE] = true;
        $options[Dumper::DEPTH] = isset($options['maxDepth']) ? $options['maxDepth'] : \TracyDebugger::getDataValue('maxDepth');
        $options[Dumper::TRUNCATE] = isset($options['maxLength']) ? $options['maxLength'] : \TracyDebugger::getDataValue('maxLength');
        $eventItem['object'] = Dumper::toHtml($event->object, $options);
        $eventItem['arguments'] = Dumper::toHtml($event->arguments, $options);
        array_push($eventItems, $eventItem);
        $this->wire('session')->tracyEventItems = $eventItems;
        if($this->hookSettings['return'] == 'false') {
            $event->replace = true;
            $event->return = false;
        }
    }


    /**
     * Hook after Pages::added
     *
     * Record the id of all added pages for the Page Recorder Panel
     *
     * @param HookEvent $event
     *
     */
    // for the page recorder panel
    protected function recordPage($event) {
        $p = $event->arguments(0);
        if($p->is("has_parent=".$this->wire('config')->adminRootPageID)) return;
        $this->data['recordedPages'][] = $p->id;
        $this->wire('modules')->saveModuleConfigData('TracyDebugger', $this->data);
    }


    /**
     * Hook before ProcessWire::finished
     *
     * This ensures Tracy will be able to show the AJAX bar when SessionHandlerDB module is installed
     *
     */
    protected function sessionHandlerDBAjaxFix() {
        if(!Debugger::$showBar) return;
        if(ob_get_level() == 0) ob_start();
        Debugger::getBar()->render();
        Debugger::$showBar = false;
    }


    /**
     * LOCAL HELPER FUNCTIONS
     */

    /**
     * Delete File
     *
     * Check if file exists before unlink
     *
     * @param string $path Full path to file
     *
     */
    private function deleteFile($path) {
        if(file_exists($path)) unlink($path);
    }


    /**
     * Minify
     *
     * Remove line breaks and unnecessary whitespace
     *
     * @param string $str String to minify
     *
     */
    public static function minify($str) {
        return preg_replace(array('#^\s*//.+$#m', '/\/\*.*?\*\//s', '/ {2,}/','/<!--.*?-->|\t|(?:\r?\n[ \t]*)+/s'),array('', '', ' ', ''), $str);
    }


    /**
     * Superuser permission check
     *
     * Actually checks if a user really has the permission
     * This works for superusers as well whereas normally they return true for any permission
     *
     * @param string|int|User Maybe User name, object, or ID. Optional user to check
     * @param string $permission Permission name
     * @return bool
     *
     */
    private function superuserHasPermission($permission) {
        foreach($this->wire('user')->roles as $role) {
            foreach($role->permissions as $perm) {
                if($perm->name == $permission) return true;
            }
        }
        return false;
    }


    /**
     * Are we in the Admin (or frontend)
     *
     * Checks based on URL, so it works before ready()
     *
     * @return bool
     *
     */
    private function inAdmin() {
        if(strpos(self::inputUrl(), $this->wire('config')->urls->admin) === 0 || ($this->wire('config')->ajax && strpos($this->httpReferer, $this->wire('config')->urls->admin) !== false)) {
            return true;
        }
        else {
            return false;
        }
    }


    /**
     * Find current page template name in cookie
     *
     * Actually checks if a user really has the permission
     * This works for superusers as well whereas normally they return true for any permission
     *
     * @param string $cookie Cookie content
     * @return string|bool Name of Template or false
     *
     */
    private function findPageTemplateInCookie($cookie) {
        $templateEntries = explode(',', $cookie);
        foreach($templateEntries as $templateEntry) {
            $arr = explode("|", $templateEntry, 2);
            if($arr[0] == $this->wire('page')->template->name) {
                return $arr[1];
                break;
            }
        }
        return false;
    }


    /**
     * Determine if server type indicator should be shown
     *
     * @return bool
     *
     */
    private function showServerTypeIndicator() {
        if(
            count($this->data['styleWhere']) > 0 &&
            ((static::$inAdmin && in_array('backend', $this->data['styleWhere'])) ||
                (!static::$inAdmin && in_array('frontend', $this->data['styleWhere'])))
        ) {
            return true;
        }
        else {
            return false;
        }
    }

    /**
     * Determine server type and return styled color
     *
     * Local or Live based on IP address and dev or staging based on subdomain
     *
     * @return string Hex color for style
     *
     */
    private function setServerAdminStyleColor() {

        $serverTypeMatch = false;
        $stylesArr = array();

        foreach(explode("\n", $this->data['styleAdminColors']) as $serverType) {
            preg_match_all("/([^\|]+)\|([^\|]+)/", $serverType, $p);
            if(isset($p[1][0]) && isset($p[2][0])) $stylesArr[$p[1][0]] = $p[2][0];
        }

        foreach($stylesArr as $type => $color) {
            if(strpos($this->wire('config')->urls->httpRoot, str_replace('*', '', $type)) !== false) {
                $serverTypeMatch = true;
                break;
            }
        }

        if(!$serverTypeMatch && static::$isLocal) {
            $serverTypeMatch = true;
            $type = 'local';
        }

        if($serverTypeMatch && isset($stylesArr[$type])) {
            if($this->data['styleAdminType'] == 'custom') {
                return '
                    <style>
                        '. str_replace(array('[color]', '[type]'), array($stylesArr[$type], str_replace('*', '', $type)), $this->data['styleAdminElements']) . '
                    </style>
                ';
            }
            else {
                return '
                    <style>
                        #tracy-debug-logo::before {
                            content: "'.str_replace('*', '', $type).'";
                            background: '.$stylesArr[$type].';
                            color: #ffffff;
                            padding: 5px 8px 3px 8px;
                            text-align: center;
                            font-family: sans-serif;
                            font-weight: 600;
                            text-transform: uppercase;
                            z-index: 999999;
                            font-size: 12px;
                            height: 13px;
                            line-height: 13px;
                            pointer-events: none;
                        }
                    </style>
                ';
            }
        }
        else return;

    }

    /**
     * Insert console code at runtime into init, ready, or finished
     *
     * @param string $when | init, ready, or finished
     *
     */
    private function insertCode($when) {
        if(!$this->wire('user')->isSuperuser() ||
            $this->wire('config')->ajax ||
            $this->wire('input')->cookie->tracyCodeError ||
            !$this->wire('input')->cookie->tracyIncludeCode)
                return;

        $options = json_decode($this->wire('input')->cookie->tracyIncludeCode, true);
        if($options['when'] !== $when) return;

        // populate API variables, eg so $page equals $this->wire('page')
        $pwVars = function_exists('wire') ? $this->fuel : \ProcessWire\wire('all');
        foreach($pwVars->getArray() as $key => $value) {
            $$key = $value;
        }
        $page = $pages->get((int)$options['pid']);
        $consoleCodeFile = $this->wire('config')->paths->cache . 'TracyDebugger/consoleCode.php';
        if(file_exists($consoleCodeFile)) {
            require_once($consoleCodeFile);
        }
        else {
            unset($_COOKIE['tracyIncludeCode']);
            $this->wire('input')->cookie->remove('tracyIncludeCode');
        }
    }


    /**
     * PUBLIC STATIC HELPER FUNCTIONS
     */


    /**
     * Remove ProcessWire variables from get_defined_vars() call
     *
     * @param array $vars Variables
     * @return array Variables with PW vars removed
     *
     */
    public static function templateVars($vars) {

        $pwVars = array('fuel','options');
        foreach(wire('config')->version >= 2.8 ? wire('fuel') : wire()->fuel as $key => $value) {
            if(!is_object($value)) continue;
            $pwVars[] = $key;
        }

        $nonPwVars = $vars;
        foreach($vars as $key => $var) {
            if(is_object($var) || is_array($var)) {
                if(in_array($key, $pwVars)) unset($nonPwVars[$key]);
            }
        }

        unset($nonPwVars['templateVars']);
        unset($nonPwVars['pwVars']);
        unset($nonPwVars['key']);
        unset($nonPwVars['value']);
        unset($nonPwVars['p']);
        unset($nonPwVars['ps']);
        unset($nonPwVars['_filename']);
        unset($nonPwVars['functions']);

        return $nonPwVars;

    }


    /**
     * Format human friendly file size and color based on thresholds
     *
     * @param string $bytes File size in bytes
     * @return string Formatted size with units and colored font
     *
     */
    public static function human_filesize($bytes) {
        if($bytes >= 500000) {
            $color = '#CD1818';
        }
        elseif($bytes < 500000 && $bytes > 100000) {
            $color = '#FF9933';
        }
        else {
            $color = '#999999';
        }

        if($bytes == 0) return("0 Bytes");
        $filesizename = array("&nbsp;Bytes", "&nbsp;KB", "&nbsp;MB", "&nbsp;GB", "&nbsp;TB", "&nbsp;PB", "&nbsp;EB", "&nbsp;ZB", "&nbsp;YB");
        return '<span style="color:'.$color.'">' . round($bytes/pow(1024, ($i = floor(log($bytes, 1024)))), 1) . $filesizename[$i] . '</span>';
    }


    /**
     * Format human friendly time and color based on thresholds
     *
     * @param string $seconds Time in seconds
     * @return string Formatted time in milliseconds with units and colored font
     *
     */
    public static function formatTime($seconds) {
        if($seconds >= 1) {
            $color = '#CD1818';
        }
        elseif($seconds < 1 && $seconds > 0.1) {
            $color = '#FF9933';
        }
        else {
            $color = '#999999';
        }

        return '<span style="color:'.$color.'">'.round(($seconds*1000), 2) . ' ms</span>';
    }


    /**
    *
    * Replace all backslashes with forward slashes
    *
    * @param string $path
    * @return string
    *
    */
    public static function forwardSlashPath($path) {
        if(DIRECTORY_SEPARATOR != '/') $path = str_replace(DIRECTORY_SEPARATOR, '/', $path);
        return $path;
    }


    /**
     * Insert generated time and size for a panel
     *
     * @param string $panel Panel name
     * @param $seconds Time in seconds
     * @param $bytes Size in bytes
     * @return string Formatted panel dom size and generation time with units and colored font
     *
     */
    public static function generatedTimeSize($panel, $seconds, $bytes) {
        \TracyDebugger::$panelGenerationTime[$panel]['time'] = $seconds;
        \TracyDebugger::$panelGenerationTime[$panel]['size'] = $bytes;
        return '<div style="clear:both; font-size:9px !important; text-align:left !important"><br />'.static::formatTime($seconds).'<span style="color: #999999;">,</span> '.static::human_filesize($bytes).'</div>';
    }


    /**
     * Create editor path
     *
     * Adjust to consider localRootPath and onlineEditor settings
     *
     * @param string $path Full path to remote version of file
     * @return string Full path to local version of file
     *
     */
    public static function createEditorLink($file, $line, $linkText, $title = null) {
        if(strpos($file, '..') !== false) return;
        $file = str_replace("%file", $file, str_replace("%line", $line, Debugger::$editor));
        $file = static::forwardSlashPath($file);
        if(static::$useOnlineEditor) $file = str_replace(static::$onlineFileEditorDirPath, '', $file);
        elseif(!static::$isLocal && self::getDataValue('localRootPath') != '') $file = str_replace(wire('config')->paths->root, self::getDataValue('localRootPath'), $file);
        return '<a '.($title ? 'title="'.$title.'"' : '').' href="'.$file.'">'.$linkText.'</a>';
    }


    /**
     * Getter function to get a $data index value from module settings
     *
     * @param string $property Property name
     * @return mixed Value of property
     *
     */
    public static function getDataValue($property) {
        if(is_array(self::$_data->$property)) {
            return self::$_data->$property;
        }
        else {
            return trim(self::$_data->$property);
        }
    }


    /**
     * Is the current debug bar standard or one of the additional (AJAX, redirect) ones
     *
     * Determine if Tracy is loading an additional panel - via AJAX, or a redirect panel
     * In this case we don't want to add most of our custom panels to the new bar because they don't change
     *
     * @return bool
     *
     */
    public static function isAdditionalBar() {
        $isRedirect = preg_match('#^Location:#im', implode("\n", headers_list()));
        if(Helpers::isAjax() || $isRedirect) {
            return Helpers::isAjax() ? 'ajax' : 'redirect';
        }
        else {
            return false;
        }
    }

    /**
     * Check IP Address again allowed address / pattern
     *
     * @return array Single key/value with module settings defined IP address and whether the user's address is allowed
     *
     */
    public static function checkIpAddress() {

        $ipAddress = static::getDataValue('ipAddress');
        $ipAddressAllowed = null;

        if($ipAddress != '') {
            if(strpos($ipAddress, '/') === 0) $ipAddressAllowed = (bool) @preg_match($ipAddress, $_SERVER['REMOTE_ADDR']); // regex IPs
                else $ipAddressAllowed = $ipAddress === $_SERVER['REMOTE_ADDR']; // exact IP match
        }
        return array('ipAddress' => $ipAddress, 'ipAddressAllowed' => $ipAddressAllowed);
    }


    /**
     * Is User allowed and what access do they have
     *
     * This considers the Tracy output mode, the user's "tracy-debugger" permissions,
     * superuser status, and IP address if relevant
     *
     * @return string|bool String is 'development' or 'production'. Bool is only for false
     *
     */
    public static function allowedTracyUsers() {

        $outputMode = static::getDataValue('outputMode');
        if($outputMode == 'detect') {
            $outputMode = static::$isLocal ? 'development' : 'production';
        }

        if(static::getDataValue('userSwitchSession') !== null) $userSwitchSession = static::getDataValue('userSwitchSession');

        $u = wire('user');

        if($u->isSuperuser() && static::getDataValue('superuserForceDevelopment') == 1 ||
            (static::$isLocal && static::getDataValue('guestForceDevelopmentLocal') == 1)) {
                return 'development';
        }
        elseif(wire('session')->tracyUserSwitcherId && (isset($userSwitchSession[wire('session')->tracyUserSwitcherId]) && $userSwitchSession[wire('session')->tracyUserSwitcherId] > time())) {
            return 'development';
        }
        elseif($outputMode == 'production') {
            return 'production';
        }
        else {
            $checkIpAddress = static::checkIpAddress();
            if($checkIpAddress['ipAddress'] != '' && $u->hasPermission('tracy-debugger')) {
                return $checkIpAddress['ipAddressAllowed'] ? 'development' : false;
            }
            elseif($u->hasPermission('tracy-debugger')) {
                return 'development';
            }
            else {
                return false;
            }
        }
    }


    /**
     * Detects if local by IP address.
     * @param  string|array  IP addresses or computer names whitelist detection
     * @return bool
     */
    public static function isLocal($list = null) {
        $addr = isset($_SERVER['REMOTE_ADDR'])
            ? $_SERVER['REMOTE_ADDR']
            : php_uname('n');
        $secret = isset($_COOKIE[self::COOKIE_SECRET]) && is_string($_COOKIE[self::COOKIE_SECRET])
            ? $_COOKIE[self::COOKIE_SECRET]
            : null;
        $list = is_string($list)
            ? preg_split('#[,\s]+#', $list)
            : (array) $list;
        if (!isset($_SERVER['HTTP_X_FORWARDED_FOR']) && !isset($_SERVER['HTTP_FORWARDED'])) {
            $list[] = '127.0.0.1';
            $list[] = '::1';
        }
        return in_array($addr, $list, true) || in_array("$secret@$addr", $list, true);
    }


    /*
    * This is a replacement for the url method from WireInput
    * There is this issue (https://github.com/processwire/processwire/pull/46)
    * but also the problem that $input->queryString() fails in init() because WireInput's $getVars isn't populated yet
    *
    * @param  bool Return with queryString or not
    * @return string URL of page with or without query string
    *
    */
    public static function inputUrl($withQueryString = false) {

        $url = '';
        /** @var Page $page */
        $page = wire('page');
        $config = wire('config');
        $sanitizer = wire('sanitizer');
        $input = wire('input');

        if($page && $page->id) {
            // pull URL from page
            $url = $page->url();
            $segmentStr = $input->urlSegmentStr();
            $pageNum = $input->pageNum();
            if(strlen($segmentStr) || $pageNum > 1) {
                if($segmentStr) $url = rtrim($url, '/') . '/' . $segmentStr;
                if($pageNum > 1) $url = rtrim($url, '/') . '/' . $config->pageNumUrlPrefix . $pageNum;
                if(isset($_SERVER['REQUEST_URI'])) {
                    $info = parse_url($_SERVER['REQUEST_URI']);
                    if(!empty($info['path']) && substr($info['path'], -1) == '/') $url .= '/'; // trailing slash
                }
                if($pageNum > 1) {
                    if($page->template->slashPageNum == 1) {
                        if(substr($url, -1) != '/') $url .= '/';
                    } else if($page->template->slashPageNum == -1) {
                        if(substr($url, -1) == '/') $url = rtrim($url, '/');
                    }
                } else if(strlen($segmentStr)) {
                    if($page->template->slashUrlSegments == 1) {
                        if(substr($url, -1) != '/') $url .= '/';
                    } else if($page->template->slashUrlSegments == -1) {
                        if(substr($url, -1) == '/') $url = rtrim($url, '/');
                    }
                }
            }

        } else if(isset($_SERVER['REQUEST_URI'])) {
            // page not yet available, attempt to pull URL from request uri
            $info = parse_url($_SERVER['REQUEST_URI']);
            $parts = explode('/', $info['path']);
            $charset = $config->pageNameCharset;
            $i = 0;
            foreach($parts as $i => $part) {
                if($i > 0) $url .= "/";
                $url .= ($charset === 'UTF8' ? $sanitizer->pageNameUTF8($part) : $sanitizer->pageName($part, false));
            }
            if(!empty($info['path']) && substr($info['path'], -1) == '/') {
                $url = rtrim($url, '/') . '/'; // trailing slash
            }
        }

        if($withQueryString && isset($_SERVER['REQUEST_URI'])) {
            $info = parse_url($_SERVER['REQUEST_URI']);
            $queryString = isset($info['query']) ? $info['query'] : '';

            if(strlen($queryString)) {
                $url .= "?$queryString";
            }
        }

        return $url;
    }

    /*
    * This is a replacement for the httpUrl method from WireInput
    */
    public static function inputHttpUrl($withQueryString = false) {
        return wire('input')->scheme() . '://' . wire('config')->httpHost . self::inputUrl($withQueryString);
    }


    /**
     * Renames files and folders appending -$n as required for the Processwire Versions panel.
     *
     * @param string Old Path
     * @param string New Path
     *
     */
    public function renamePwVersions($oldPath, $newPath, $addN = false) {
        if(file_exists($newPath) && $addN) {
            $n = 0;
            do { $newPath2 = $newPath . "-" . (++$n); } while(file_exists($newPath2));
            rename($newPath, $newPath2);
        }
        rename($oldPath, $newPath);
    }


    public function __destruct() {

        // if using Test mode in File Editor on regular files, then immediately replace loaded file with backed up version
        // this is here instead of ProcessWire::finished because this works if test version has fatal error
        if(isset($_COOKIE['tracyTestFileEditor'])) {
            $this->filePath = $this->wire('config')->paths->root . ($this->wire('input')->post->fileEditorFilePath ?: $this->wire('input')->cookie->tracyTestFileEditor);
            $this->cachePath = $this->wire('config')->paths->cache . 'TracyDebugger/' . ($this->wire('input')->post->fileEditorFilePath ?: $this->wire('input')->cookie->tracyTestFileEditor);
            if(file_exists($this->cachePath)) {
                copy($this->cachePath, $this->filePath);
                unlink($this->cachePath);
            }
        }

        // delete temporary template file after it's been rendered
        // this is from the File Editor panel
        if(isset($this->tempTemplateFilename) && file_exists($this->tempTemplateFilename)) unlink($this->tempTemplateFilename);

        // modify paths to /wire/, index.php, and .htaccess when using PW Version Switcher
        if($this->wire('input')->post->tracyPwVersion && $this->wire('input')->post->tracyPwVersion != $this->wire('config')->version) {

            $rootPath = $this->wire('config')->paths->root;

            // rename wire
            $this->renamePwVersions($rootPath.'wire', $rootPath.'.wire-'.$this->wire('config')->version, true);
            $this->renamePwVersions($rootPath.'.wire-'.$this->wire('input')->post->tracyPwVersion, $rootPath.'wire');

            // rename .htaccess if previously replaced
            if(file_exists($rootPath.'.htaccess-'.$this->wire('input')->post->tracyPwVersion)) {
                $this->renamePwVersions($rootPath.'.htaccess', $rootPath.'.htaccess-'.$this->wire('config')->version, true);
                $this->renamePwVersions($rootPath.'.htaccess-'.$this->wire('input')->post->tracyPwVersion, $rootPath.'.htaccess');
            }
            // rename index.php if previously replaced
            if(file_exists($rootPath.'.index-'.$this->wire('input')->post->tracyPwVersion.'.php')) {
                $this->renamePwVersions($rootPath.'index.php', $rootPath.'.index-'.$this->wire('config')->version.'.php', true);
                $this->renamePwVersions($rootPath.'.index-'.$this->wire('input')->post->tracyPwVersion.'.php', $rootPath.'index.php');
            }
        }
    }


    /**
     * Return an InputfieldWrapper of Inputfields used to configure the class
     *
     * @param array $data Array of config values indexed by field name
     * @return InputfieldsWrapper
     *
     */
    public function getModuleConfigInputfields(array $data) {

        // convert PW Info panel custom links from path back to ID
        if(isset($data['customPWInfoPanelLinks'])) {
            $customPWInfoPanelLinkIds = array();
            $customPWInfoPanelLinks = $data['customPWInfoPanelLinks'];
            if(method_exists($this->wire('pages'), 'getByPath')) {
                foreach($customPWInfoPanelLinks as $pagePath) {
                    array_push($customPWInfoPanelLinkIds, $this->wire('pages')->getByPath($pagePath, array('getID' => true, 'useHistory' => true)));
                }
            }
            // fallback for PW < 3.0.6 when getByPath method did not exist
            else {
                foreach($customPWInfoPanelLinks as $pagePath) {
                    array_push($customPWInfoPanelLinkIds, $this->wire('pages')->get($pagePath)->id);
                }
            }
            $data['customPWInfoPanelLinks'] = $customPWInfoPanelLinkIds;
        }


        if($this->wire('input')->post->submit_save_module) {
            unset($this->wire('input')->cookie->tracyPanelsSticky);
            setcookie("tracyPanelsSticky", "", time()-3600, '/');
            unset($this->wire('input')->cookie->tracyModulesDisabled);
            setcookie("tracyModulesDisabled", "", time()-3600, '/');
            unset($this->wire('input')->cookie->tracyDisabled);
            setcookie("tracyDisabled", "", time()-3600, '/');
        }

        if($this->wire('input')->post->clearEmailSent) {
            $emailSentPath = $this->wire('config')->paths->logs.'tracy/email-sent';
            if(file_exists($emailSentPath)) {
                $removed = unlink($emailSentPath);
            }
            if (!isset($removed) || !$removed) wire()->error( __('No file to remove'));
            else wire()->message(__("email-sent file deleted successfully"));
        }

        $data = array_merge(self::getDefaultData(), $data);

        $wrapper = new InputfieldWrapper();

        // Main Setup
        $fieldset = $this->wire('modules')->get("InputfieldMarkup");
        $fieldset->label = __(' ', __FILE__);
        $fieldset->value = '
        <p><strong><img src="https://adrianbj.github.io/TracyDebugger/img/icon.svg" style="display:inline; vertical-align: middle; margin:0 15px 0 0; width: 50px" />Tracy Debugger for ProcessWire v'.$this->getModuleInfo()['version'].'</strong></p>
        <p style="margin-left:55px"><i class="fa fa-fw fa-lg fa-book"></i> <a href="https://adrianbj.github.io/TracyDebugger">TracyDebugger for ProcessWire Docs</a> and <a href="https://tracy.nette.org/">Nette Tracy Docs</a><p>
        <p style="margin-left:55px"><i class="fa fa-fw fa-lg fa-github"></i> <a href="https://github.com/adrianbj/TracyDebugger">Star on Github</a></p>
        <p style="margin-left:55px"><img class="fa fa-fw" style="display:inline; vertical-align: middle; margin:0 4px" src="https://adrianbj.github.io/TracyDebugger/icons/processwire-info.svg"> <a href="http://modules.processwire.com/modules/tracy-debugger/">Recommend in the Modules Directory</a></strong></p>
        ';
        $wrapper->add($fieldset);

        // Main Setup
        $fieldset = $this->wire('modules')->get("InputfieldFieldset");
        $fieldset->label = __('Main setup', __FILE__);
        $wrapper->add($fieldset);

        $f = $this->wire('modules')->get("InputfieldCheckbox");
        $f->attr('name', 'enabled');
        $f->label = __('Enable Tracy Debugger', __FILE__);
        $f->description = __('Uncheck to completely disable all Tracy Debugger features.', __FILE__);
        $f->columnWidth = 50;
        $f->attr('checked', $data['enabled'] == '1' ? 'checked' : '' );
        $fieldset->add($f);

/*
        $f = $this->wire('modules')->get("InputfieldSelect");
        $f->attr('name', 'coreBranch');
        $f->label = 'Core Tracy Branch';
        $f->description = __('Which version of the Tracy core to use. Master (dev) requires PHP 5.4.4+ and will be automatically selected if your PHP version is sufficient.', __FILE__);
        $f->columnWidth = 50;
        $f->required = true;
        $f->addOption('master', 'Master');
        $f->addOption('legacy', 'Legacy (for PHP < 5.4.4)');
        if($data['coreBranch']) $f->attr('value', $data['coreBranch']);
        $fieldset->add($f);
*/

        $f = $this->wire('modules')->get("InputfieldSelect");
        $f->attr('name', 'outputMode');
        $f->label = 'Output mode';
        $f->description = __('The DETECT option automatically switches from DEVELOPMENT to PRODUCTION mode based on whether the IP of the site is publicly accessible or not.', __FILE__);
        $f->notes = __('In PRODUCTION mode, all errors and dumps etc are logged to file. Nothing is displayed in the browser. In DEVELOPMENT mode, the debug bar is displayed for authorized users - superusers and those with the "tracy-debugger" permission. All other users will be forced into PRODUCTION mode, regardless of this setting.', __FILE__);
        $f->columnWidth = 50;
        $f->required = true;
        $f->addOption('detect', 'DETECT');
        $f->addOption('development', 'DEVELOPMENT');
        $f->addOption('production', 'PRODUCTION');
        if($data['outputMode']) $f->attr('value', $data['outputMode']);
        $fieldset->add($f);

        // Access Permissions
        $fieldset = $this->wire('modules')->get("InputfieldFieldset");
        $fieldset->label = __('Access permission', __FILE__);
        $wrapper->add($fieldset);

        $f = $this->wire('modules')->get("InputfieldCheckbox");
        $f->attr('name', 'superuserForceDevelopment');
        $f->label = __('Force superusers into DEVELOPMENT mode', __FILE__);
        $f->description = __('Check to force DEVELOPMENT mode for superusers even on live sites.', __FILE__);
        $f->notes = __('By default, the Output Mode setting\'s DETECT option will force a site into PRODUCTION mode when it is live, which hides the DebugBar and sends errors and dumps to log files. However, with this checked, superusers will always be in DEVELOPMENT mode.', __FILE__);
        $f->columnWidth = 33;
        $f->attr('checked', $data['superuserForceDevelopment'] == '1' ? 'checked' : '' );
        $fieldset->add($f);

        $f = $this->wire('modules')->get("InputfieldCheckbox");
        $f->attr('name', 'guestForceDevelopmentLocal');
        $f->label = __('Force guest users into DEVELOPMENT mode on localhost', __FILE__);
        $f->description = __('Check to force DEVELOPMENT mode for guests when server detected as localhost.', __FILE__);
        $f->notes = __('By default, guest users will always be in PRODUCTION mode (no debug bar). However, with this checked, they will always be in DEVELOPMENT mode on localhost.', __FILE__);
        $f->columnWidth = 34;
        $f->attr('checked', $data['guestForceDevelopmentLocal'] == '1' ? 'checked' : '' );
        $fieldset->add($f);

        $f = $this->wire('modules')->get("InputfieldText");
        $f->attr('name', 'ipAddress');
        $f->label = __('Restrict non-superusers', __FILE__);
        $f->description = __('IP Address that non-superusers need to use TracyDebugger. Enter IP address or a PCRE regular expression to match IP address of user, eg. /^123\.456\.789\./ would match all IP addresses that started with 123.456.789.', __FILE__);
        $f->columnWidth = 33;
        $f->notes = __('Non-superusers are already blocked unless they have the "tracy-debugger" permission. But once a user has been given the permission, this option restricts access to the listed IP address. Highly recommended for debugging live sites that you have manually set into DEVELOPMENT mode.', __FILE__);
        if($data['ipAddress']) $f->attr('value', $data['ipAddress']);
        $fieldset->add($f);

        // Miscellaneous Settings
        $fieldset = $this->wire('modules')->get("InputfieldFieldset");
        $fieldset->label = __('Miscellaneous', __FILE__);
        $wrapper->add($fieldset);

        $f = $this->wire('modules')->get("InputfieldCheckbox");
        $f->attr('name', 'strictMode');
        $f->label = __('Strict mode', __FILE__);
        $f->description = __('Check to enable strict mode which displays notices and warnings like errors.', __FILE__);
        $f->columnWidth = 33;
        $f->attr('checked', $data['strictMode'] == '1' ? 'checked' : '' );
        $fieldset->add($f);

        $f = $this->wire('modules')->get("InputfieldCheckbox");
        $f->attr('name', 'strictModeAjax');
        $f->label = __('Strict mode AJAX only', __FILE__);
        $f->description = __('Check to enable strict mode only for AJAX calls.', __FILE__);
        $f->notes = __('Because Tracy intercepts notices and warnings, these will no longer be returned with the AJAX response which may result in a "success" reponse, rather than "failure". Notices and warnings from an AJAX call will be displayed in the AJAX bar\'s Errors panel, but you still might prefer this option as it provides a more prominent indication of failure.', __FILE__);
        $f->showIf="strictMode!='1'";
        $f->columnWidth = 34;
        $f->attr('checked', $data['strictModeAjax'] == '1' ? 'checked' : '' );
        $fieldset->add($f);

        $f = $this->wire('modules')->get("InputfieldCheckbox");
        $f->attr('name', 'forceScream');
        $f->label = __('Force scream', __FILE__);
        $f->description = __('Check to force "scream" of mode which disables the @ (silence/shut-up) operator so that notices and warnings are no longer hidden.', __FILE__);
        $f->notes = __('This is disabled when Strict Mode is enabled because of a bug? [https://forum.nette.org/en/25569-strict-and-scream-modes-together](https://forum.nette.org/en/25569-strict-and-scream-modes-together) in the core Tracy package.', __FILE__);
        $f->showIf="strictMode!='1', strictModeAjax!='1'";
        $f->columnWidth = 33;
        $f->attr('checked', $data['forceScream'] == '1' ? 'checked' : '' );
        $fieldset->add($f);

        $f = $this->wire('modules')->get("InputfieldCheckboxes");
        $f->attr('name', 'showLocation');
        $f->label = 'Show location';
        $f->description = __('Shows the location of dump() and barDump() calls.', __FILE__);
        $f->notes = __('LOCATION_SOURCE adds tooltip with path to the file, where the function was called.'."\n".'LOCATION_LINK adds a link to the file which can be opened directly.'."\n".'LOCATION_CLASS adds a tooltip to every dumped object containing path to the file, in which the object\'s class is defined.');
        $f->columnWidth = 50;
        $f->addOption('Tracy\Dumper::LOCATION_SOURCE', 'LOCATION_SOURCE');
        $f->addOption('Tracy\Dumper::LOCATION_LINK', 'LOCATION_LINK');
        $f->addOption('Tracy\Dumper::LOCATION_CLASS', 'LOCATION_CLASS');
        if($data['showLocation']) $f->attr('value', $data['showLocation']);
        $fieldset->add($f);

        $f = $this->wire('modules')->get("InputfieldInteger");
        $f->attr('name', 'maxDepth');
        $f->label = __('Maximum nesting depth', __FILE__);
        $f->description = __('Set the maximum nesting depth of dumped arrays and objects.', __FILE__);
        $f->notes = __('Default: 3. Warning: making this too large can slow your page load down or even crash your browser.', __FILE__);
        $f->columnWidth = 25;
        $f->attr('value', $data['maxDepth']);
        $fieldset->add($f);

        $f = $this->wire('modules')->get("InputfieldInteger");
        $f->attr('name', 'maxLength');
        $f->label = __('Maximum string length', __FILE__);
        $f->description = __('Set the maximum displayed strings length.', __FILE__);
        $f->notes = __('Default: 150.', __FILE__);
        $f->columnWidth = 25;
        $f->attr('value', $data['maxLength']);
        $fieldset->add($f);

        $f = $this->wire('modules')->get("InputfieldCheckbox");
        $f->attr('name', 'referencePageEdited');
        $f->label = __('Reference page being edited', __FILE__);
        $f->description = __('When editing a page in the admin, the Request Info Panel will show details of the page being edited, and the Consol Panel will assign the $page variable to the page being edited.', __FILE__);
        $f->notes = __('Highly recommended unless you have a reason not to do this.', __FILE__);
        $f->attr('checked', $data['referencePageEdited'] == '1' ? 'checked' : '' );
        $fieldset->add($f);

        // Error Logging Settings
        $fieldset = $this->wire('modules')->get("InputfieldFieldset");
        $fieldset->label = __('Error logging', __FILE__);
        $wrapper->add($fieldset);

        $f = $this->wire('modules')->get("InputfieldCheckboxes");
        $f->attr('name', 'logSeverity');
        $f->label = 'Log severity';
        $f->description = __('If you want Tracy to log PHP errors like E_NOTICE or E_WARNING with detailed information (HTML report), set them here.', __FILE__);
        $f->notes = __('These only affect log file content, not onscreen debug info.');
        $f->columnWidth = 40;
        $f->addOption('E_ERROR', 'E_ERROR');
        $f->addOption('E_WARNING', 'E_WARNING');
        $f->addOption('E_PARSE', 'E_PARSE');
        $f->addOption('E_NOTICE', 'E_NOTICE');
        $f->addOption('E_CORE_ERROR', 'E_CORE_ERROR');
        $f->addOption('E_CORE_WARNING', 'E_CORE_WARNING');
        $f->addOption('E_COMPILE_ERROR', 'E_COMPILE_ERROR');
        $f->addOption('E_COMPILE_WARNING', 'E_COMPILE_WARNING');
        $f->addOption('E_USER_ERROR', 'E_USER_ERROR');
        $f->addOption('E_USER_WARNING', 'E_USER_WARNING');
        $f->addOption('E_USER_NOTICE', 'E_USER_NOTICE');
        $f->addOption('E_STRICT', 'E_STRICT');
        $f->addOption('E_RECOVERABLE_ERROR', 'E_RECOVERABLE_ERROR');
        $f->addOption('E_DEPRECATED', 'E_DEPRECATED');
        $f->addOption('E_USER_DEPRECATED', 'E_USER_DEPRECATED');
        $f->addOption('E_ALL', 'E_ALL');
        if($data['logSeverity']) $f->attr('value', $data['logSeverity']);
        $fieldset->add($f);

        $f = $this->wire('modules')->get("InputfieldEmail");
        $f->attr('name', 'email');
        $f->label = __('Email for production errors', __FILE__);
        $f->description = __('Receive emails at this address when an error occurs in production mode.', __FILE__);
        $f->columnWidth = 40;
        if($data['email']) $f->attr('value', $data['email']);
        $fieldset->add($f);

        $f = $this->wire('modules')->get("InputfieldCheckbox");
        $f->attr('name', 'clearEmailSent');
        $f->label = __('Clear "email sent" flag', __FILE__);
        $f->description = __('Check and save settings to remove the "email-sent" file so that you will start receiving new error emails.', __FILE__);
        $f->columnWidth = 20;
        $fieldset->add($f);

        // Debug Bar and Panel Settings
        $fieldset = $this->wire('modules')->get("InputfieldFieldset");
        $fieldset->label = __('Debug bar and panels', __FILE__);
        $wrapper->add($fieldset);

        $f = $this->wire('modules')->get("InputfieldCheckboxes");
        $f->attr('name', 'showDebugBar');
        $f->label = __('Show debug bar', __FILE__);
        $f->description = __('Show the debug bar.', __FILE__);
        $f->columnWidth = 33;
        $f->addOption('frontend', 'Frontend');
        $f->addOption('backend', 'Backend');
        if($data['showDebugBar']) $f->attr('value', $data['showDebugBar']);
        $fieldset->add($f);

        $f = $this->wire('modules')->get("InputfieldCheckboxes");
        $f->attr('name', 'hideDebugBarModals');
        $f->label = __('No debug bar in ...', __FILE__);
        $f->columnWidth = 34;
        $f->addOption('regularModal', 'Regular Modal');
        $f->addOption('inlineModal', 'Inline Modal');
        $f->addOption('overlayPanels', 'Overlay Panels');
        $f->addOption('formBuilderIframe', 'Form Builder iframe');
        if($data['hideDebugBarModals']) $f->attr('value', $data['hideDebugBarModals']);
        $fieldset->add($f);

        $f = $this->wire('modules')->get("InputfieldAsmSelect");
        $f->attr('name', 'hideDebugBarTemplates');
        $f->label = __('No debug bar in selected templates', __FILE__);
        $f->description = __('Disable the debug bar on pages with the selected templates.', __FILE__);
        $f->columnWidth = 33;
        foreach($this->wire('templates') as $t) {
            $f->addOption($t->id, $t->name);
        }
        if($data['hideDebugBarTemplates']) $f->attr('value', $data['hideDebugBarTemplates']);
        $fieldset->add($f);

        $f = $this->wire('modules')->get("InputfieldCheckbox");
        $f->attr('name', 'hideDebugBar');
        $f->label = __('Hide debug bar by default', __FILE__);
        $f->description = __('Hide the debug bar by default on page load.', __FILE__);
        $f->notes = __('This results in the bar being hidden (unless an error is reported), and replaced with a small "show bar" &#8689; icon.', __FILE__);
        $f->columnWidth = 33;
        $f->attr('checked', $data['hideDebugBar'] == '1' ? 'checked' : '' );
        $fieldset->add($f);

        $f = $this->wire('modules')->get("InputfieldCheckbox");
        $f->attr('name', 'showPanelLabels');
        $f->label = __('Show panel labels', __FILE__);
        $f->description = __('Show the labels next to each panel.', __FILE__);
        $f->notes = __('Unchecking this will make the debugger bar much more compact.', __FILE__);
        $f->columnWidth = 34;
        $f->attr('checked', $data['showPanelLabels'] == '1' ? 'checked' : '' );
        $fieldset->add($f);

        $f = $this->wire('modules')->get("InputfieldInteger");
        $f->attr('name', 'panelZindex');
        $f->label = __('Starting zIndex for panels', __FILE__);
        $f->description = __('Adjust if you find panels are below/above elements that you don\'t want.', __FILE__);
        $f->notes = __('Default: 100', __FILE__);
        $f->columnWidth = 33;
        if($data['panelZindex']) $f->attr('value', $data['panelZindex']);
        $fieldset->add($f);

        $f = $this->wire('modules')->get("InputfieldAsmSelect");
        $f->attr('name', 'frontendPanels');
        $f->label = __('Frontend panels', __FILE__);
        $f->description = __('Determines which panels are shown in the Debug Bar on the frontend. Sort to match order of panels in Debugger Bar.', __FILE__);
        $f->columnWidth = 50;
        foreach(static::$allPanels as $name => $label) {
            $f->addOption($name, $label);
        }
        if($data['frontendPanels']) $f->attr('value', $data['frontendPanels']);
        $fieldset->add($f);

        $f = $this->wire('modules')->get("InputfieldAsmSelect");
        $f->attr('name', 'backendPanels');
        $f->label = __('Backend panels', __FILE__);
        $f->description = __('Determines which panels are shown in the Debug Bar on the backend. Sort to match order of panels in Debugger Bar.', __FILE__);
        $f->notes = __('Note that '.implode(', ', static::$hideInAdmin).' are intentionally missing from this list because they have no use in the backend.', __FILE__);
        $f->columnWidth = 50;
        foreach(static::$allPanels as $name => $label) {
            if(!in_array($name, static::$hideInAdmin)) {
                $f->addOption($name, $label);
            }
        }
        if($data['backendPanels']) $f->attr('value', $data['backendPanels']);
        $fieldset->add($f);

        $f = $this->wire('modules')->get("InputfieldCheckboxes");
        $f->attr('name', 'restrictedUserDisabledPanels');
        $f->label = __('Disabled panels for restricted users', __FILE__);
        $f->description = __('Check the panels that should NOT be shown to users with the "tracy-restricted-panels" role or permission.', __FILE__);
        $f->notes = __('Unchecked panels will still only be shown to restricted users if they are selected in the Front/Back-end options above.', __FILE__);
        $f->optionColumns = 3;
        foreach(static::$allPanels as $name => $label) {
            $f->addOption($name, $label);
        }
        if($data['restrictedUserDisabledPanels']) $f->attr('value', $data['restrictedUserDisabledPanels']);
        $fieldset->add($f);

        // Editor Protocol Handler
        $fieldset = $this->wire('modules')->get("InputfieldFieldset");
        $fieldset->label = __('Editor links', __FILE__);
        $wrapper->add($fieldset);

        $f = $this->wire('modules')->get("InputfieldText");
        $f->attr('name', 'editor');
        $f->label = __('Editor protocol handler', __FILE__);
        $f->description = __('Sets the Tracy `Debugger::$editor` variable. Enter the appropriate address to open your code editor of choice.'."\n".'This approach only works for OSX. For more instructions on Windows and Linux alternatives, [read here](https://pla.nette.org/en/how-open-files-in-ide-from-debugger).'."\n".'For easily adding the SublimeText "subl://" protocol handler to your Mac, use this free [tool](https://github.com/saetia/sublime-url-protocol-mac).'."\n".' For other editors/IDEs, Google "protocol handler editorname".', __FILE__);
        $f->notes = __('Initially configured for SublimeText (`subl://open/?url=file://%file&line=%line`). Change to work with your favorite editor.', __FILE__);
        $f->columnWidth = 50;
        if($data['editor']) $f->attr('value', $data['editor']);
        $fieldset->add($f);

        $f = $this->wire('modules')->get("InputfieldText");
        $f->attr('name', 'localRootPath');
        $f->label = __('Local root path', __FILE__);
        $f->description = __('Maps editor links from live site to local dev files. Only used if you are viewing a live site, otherwise it is ignored.', __FILE__);
        $f->notes = __('An example path on MacOS might be: /Users/myname/Sites/sitefolder/', __FILE__);
        $f->columnWidth = 50;
        if($data['localRootPath']) $f->attr('value', $data['localRootPath']);
        $fieldset->add($f);

        $f = $this->wire('modules')->get("InputfieldCheckboxes");
        $f->attr('name', 'useOnlineEditor');
        $f->label = __('Use online editor for links', __FILE__);
        $f->description = __('This will open links in an online editor (Tracy File Editor or ProcessFileEdit) instead of your code editor.', __FILE__);
        $f->notes = __('You can choose which editor after selecting at least one of these.', __FILE__);
        $f->columnWidth = 50;
        $f->addOption('live', 'Live');
        $f->addOption('local', 'Local');
        if($data['useOnlineEditor']) $f->attr('value', $data['useOnlineEditor']);
        $fieldset->add($f);

        $f = $this->wire('modules')->get("InputfieldRadios");
        $f->attr('name', 'onlineEditor');
        $f->label = __('Online editor', __FILE__);
        $f->description = __('Which online editor to use: Tracy File Editor or [ProcessFileEdit (Files Editor)](http://modules.processwire.com/modules/process-file-edit/).', __FILE__);
        if($this->wire('modules')->isInstalled('ProcessFileEdit')) {
            $f->notes = __('Process File Edit is installed, but you may want to adjust its [settings]('.$this->wire('config')->urls->admin.'module/edit?name=ProcessFileEdit)', __FILE__);
        }
        else {
            $f->notes = __('Process File Edit is NOT installed - you need to install it for the option to appear.', __FILE__);
        }
        $f->columnWidth = 50;
        $f->showIf = "useOnlineEditor.count>0";
        $f->requiredIf = "useOnlineEditor.count>0";
        $f->addOption('tracy', 'Tracy File Editor');
        if($this->wire('modules')->isInstalled('ProcessFileEdit')) $f->addOption('processFileEdit', 'ProcessFileEdit');
        if($data['onlineEditor']) $f->attr('value', $data['onlineEditor']);
        $fieldset->add($f);

        $f = $this->wire('modules')->get("InputfieldCheckbox");
        $f->attr('name', 'forceEditorLinksToTracy');
        $f->label = __('Force editor links to use Tracy File Editor', __FILE__);
        $f->description = __('Even if neither of the "Use Online Editor for Links" options are checked, if the File Editor Panel is enabled, all links will be sent to it.', __FILE__);
        $f->notes = __("RECOMMENDED: This is a handy option if you generally want links to use your code editor, but want the option to use the File Editor occasionally.\nYou can enable it (once or sticky) from the Panel selector on the debug bar without the need to change the above settings.", __FILE__);
        $f->attr('checked', $data['forceEditorLinksToTracy'] == '1' ? 'checked' : '' );
        $fieldset->add($f);

        // File Editor Panel
        $fieldset = $this->wire('modules')->get("InputfieldFieldset");
        $fieldset->label = __('File Editor panel', __FILE__);
        $fieldset->description = __("These settings don't affect links opened via the Editor Protocol Handler. They only affect browsing directly from the File Editor folder/file selector sidebar.");
        $wrapper->add($fieldset);

        $f = $this->wire('modules')->get("InputfieldMarkup");
        $f->attr('name', 'fileEditorNote');
        $f->showIf = "useOnlineEditor.count>0, onlineEditor!=processFileEdit";
        $f->value = __('Because you are using Tracy File Editor for the editor links, the File Editor Panel will be enabled, even if you don\'t have it selected in the Frontend/Backend Panel selections above.', __FILE__);
        $fieldset->add($f);

        $f = $this->wire('modules')->get("InputfieldSelect");
        $f->attr('name', 'fileEditorBaseDirectory');
        $f->label = __('Base directory', __FILE__);
        $f->description = __('A more specific selection results in better performance in the File Editor Panel.', __FILE__);
        $f->columnWidth = 50;
        $f->addOption('root', 'Root');
        $f->addOption('site', 'Site');
        $f->addOption('templates', 'Templates');
        $f->required = true;
        if($data['fileEditorBaseDirectory']) $f->attr('value', $data['fileEditorBaseDirectory']);
        $fieldset->add($f);

        $f = $this->wire('modules')->get("InputfieldText");
        $f->attr('name', 'fileEditorAllowedExtensions');
        $f->label = __('Allowed extensions', __FILE__);
        $f->description = __('List of extensions that can be opened in the editor. Fewer extensions results in better performance in the File Editor Panel.', __FILE__);
        $f->notes = __('Initially configured for: php, module, js, css, htaccess', __FILE__);
        $f->columnWidth = 50;
        if($data['fileEditorAllowedExtensions']) $f->attr('value', $data['fileEditorAllowedExtensions']);
        $fieldset->add($f);

        // ProcessWire Info Panel
        $fieldset = $this->wire('modules')->get("InputfieldFieldset");
        $fieldset->label = __('ProcessWire Info panel', __FILE__);
        $wrapper->add($fieldset);

        $f = $this->wire('modules')->get("InputfieldCheckboxes");
        $f->attr('name', 'processwireInfoPanelSections');
        $f->label = __('Panel sections', __FILE__);
        $f->description = __('Which sections to include in the ProcessWire Info panel.', __FILE__);
        $f->columnWidth = 50;
        foreach(static::$processWireInfoSections as $name => $label) {
            $f->addOption($name, $label);
        }
        if($data['processwireInfoPanelSections']) $f->attr('value', $data['processwireInfoPanelSections']);
        $fieldset->add($f);

        $f = $this->wire('modules')->get("InputfieldPageListSelectMultiple");
        $f->attr('name', 'customPWInfoPanelLinks');
        $f->label = __('Custom links', __FILE__);
        $f->description = __('Choose pages you would like links to.', __FILE__);
        $f->notes = __('To provide links to items under the Setup menu, navigate to Admin > Setup >', __FILE__);
        $f->columnWidth = 50;
        if($data['customPWInfoPanelLinks']) $f->attr('value', $data['customPWInfoPanelLinks']);
        $fieldset->add($f);

        $f = $this->wire('modules')->get("InputfieldCheckbox");
        $f->attr('name', 'showPWInfoPanelIconLabels');
        $f->label = __('Show icon labels', __FILE__);
        $f->description = __('Shows labels next to each icon for the two "Links" sections.', __FILE__);
        $f->notes = __('Nice for clarity, but takes up more space.', __FILE__);
        $f->columnWidth = 50;
        $f->attr('checked', $data['showPWInfoPanelIconLabels'] == '1' ? 'checked' : '' );
        $fieldset->add($f);

        $f = $this->wire('modules')->get("InputfieldCheckbox");
        $f->attr('name', 'pWInfoPanelLinksNewTab');
        $f->label = __('Open links in new tab', __FILE__);
        $f->description = __('Makes links open in a new browser tab.', __FILE__);
        $f->columnWidth = 50;
        $f->attr('checked', $data['pWInfoPanelLinksNewTab'] == '1' ? 'checked' : '' );
        $fieldset->add($f);

        // Request Info Panel
        $fieldset = $this->wire('modules')->get("InputfieldFieldset");
        $fieldset->label = __('Request Info panel', __FILE__);
        $wrapper->add($fieldset);

        $f = $this->wire('modules')->get("InputfieldCheckboxes");
        $f->attr('name', 'requestInfoPanelSections');
        $f->label = __('Panel sections', __FILE__);
        $f->description = __('Which sections to include in the Request Info panel.', __FILE__);
        $f->notes = __('The three "Object" options will significantly increase the size of this panel.', __FILE__);
        foreach(static::$requestInfoSections as $name => $label) {
            $f->addOption($name, $label);
        }
        if($data['requestInfoPanelSections']) $f->attr('value', $data['requestInfoPanelSections']);
        $fieldset->add($f);

        // Debug Mode Panel
        $fieldset = $this->wire('modules')->get("InputfieldFieldset");
        $fieldset->label = __('Debug Mode panel', __FILE__);
        $wrapper->add($fieldset);

        $f = $this->wire('modules')->get("InputfieldCheckboxes");
        $f->attr('name', 'debugModePanelSections');
        $f->label = __('Panel sections', __FILE__);
        $f->description = __('Which sections to include in the Debug Mode panel.', __FILE__);
        $f->columnWidth = 50;
        foreach(static::$debugModeSections as $name => $label) {
            $f->addOption($name, $label);
        }
        if($data['debugModePanelSections']) $f->attr('value', $data['debugModePanelSections']);
        $fieldset->add($f);

        $f = $this->wire('modules')->get("InputfieldCheckbox");
        $f->attr('name', 'alwaysShowDebugTools');
        $f->label = __('Show debug mode tools even if $config->debug = false.', __FILE__);
        $f->description = __('If checked, the debug tools will be displayed regardless of whether debug mode is enabled.', __FILE__);
        $f->columnWidth = 50;
        $f->attr('checked', $data['alwaysShowDebugTools'] == '1' ? 'checked' : '' );
        $fieldset->add($f);

        // Diagnostics Panel
        $fieldset = $this->wire('modules')->get("InputfieldFieldset");
        $fieldset->label = __('Diagnostics panel', __FILE__);
        $wrapper->add($fieldset);

        $f = $this->wire('modules')->get("InputfieldCheckboxes");
        $f->attr('name', 'diagnosticsPanelSections');
        $f->label = __('Panel sections', __FILE__);
        $f->description = __('Which sections to include in the Diagnostics panel.', __FILE__);
        $f->notes = __('The "Filesystem Files" option may significantly increase the generation time for this panel.', __FILE__);
        foreach(static::$diagnosticsSections as $name => $label) {
            $f->addOption($name, $label);
        }
        if($data['diagnosticsPanelSections']) $f->attr('value', $data['diagnosticsPanelSections']);
        $fieldset->add($f);

        // ToDo Panel
        $fieldset = $this->wire('modules')->get("InputfieldFieldset");
        $fieldset->label = __('TODO panel', __FILE__);
        $wrapper->add($fieldset);

        $f = $this->wire('modules')->get("InputfieldTextarea");
        $f->attr('name', 'todoIgnoreDirs');
        $f->label = __('Ignore directories', __FILE__);
        $f->description = __('Comma separated list of terms used to match folders to be ignored when scanning for ToDo items.', __FILE__);
        $f->notes = __('Default: git, svn, images, img, errors, sass-cache, node_modules', __FILE__);
        $f->columnWidth = 40;
        if($data['todoIgnoreDirs']) $f->attr('value', $data['todoIgnoreDirs']);
        $fieldset->add($f);

        $f = $this->wire('modules')->get("InputfieldText");
        $f->attr('name', 'todoAllowedExtensions');
        $f->label = __('Allowed extensions', __FILE__);
        $f->description = __('Comma separated list file extensions to be scanned for ToDo items.', __FILE__);
        $f->notes = __('Default: php, module, inc, txt, latte, html, htm, md, css, scss, less, js', __FILE__);
        $f->columnWidth = 40;
        if($data['todoAllowedExtensions']) $f->attr('value', $data['todoAllowedExtensions']);
        $fieldset->add($f);

        $f = $this->wire('modules')->get("InputfieldCheckbox");
        $f->attr('name', 'todoScanModules');
        $f->label = __('Scan site modules', __FILE__);
        $f->description = __('Check to allow the ToDo to scan the /site/modules directory. Otherwise it will only scan /site/templates.', __FILE__);
        $f->notes = __('Not recommended unless you are a regular module developer.', __FILE__);
        $f->columnWidth = 20;
        $f->attr('checked', $data['todoScanModules'] == '1' ? 'checked' : '' );
        $fieldset->add($f);

        // ProcessWire and Tracy Log Panels
        $fieldset = $this->wire('modules')->get("InputfieldFieldset");
        $fieldset->label = __('ProcessWire and Tracy Log panels', __FILE__);
        $wrapper->add($fieldset);

        $f = $this->wire('modules')->get("InputfieldInteger");
        $f->attr('name', 'numLogEntries');
        $f->label = __('Number of log entries', __FILE__);
        $f->description = __('Set the number of log entries to be displayed for the Tracy and ProcessWire log viewer panels.', __FILE__);
        $f->notes = __('Default: 10', __FILE__);
        $f->attr('value', $data['numLogEntries']);
        $fieldset->add($f);

        // Template Resources Panel
        $fieldset = $this->wire('modules')->get("InputfieldFieldset");
        $fieldset->label = __('Template Resources panel', __FILE__);
        $wrapper->add($fieldset);

        $f = $this->wire('modules')->get("InputfieldCheckbox");
        $f->attr('name', 'variablesShowPwObjects');
        $f->label = __('Show content of ProcessWire objects', __FILE__);
        $f->description = __('Shows the full ProcessWire object contents, rather than arrays of values. Only recommended for specific debugging purposes.', __FILE__);
        $f->notes = __('Checking this will significantly increase the size of this panel if you have any variables set to ProcessWire objects.', __FILE__);
        $f->attr('checked', $data['variablesShowPwObjects'] == '1' ? 'checked' : '' );
        $fieldset->add($f);

        // Snippet Runner Panel
        $fieldset = $this->wire('modules')->get("InputfieldFieldset");
        $fieldset->label = __('Snippet Runner panel', __FILE__);
        $wrapper->add($fieldset);

        $f = $this->wire('modules')->get("InputfieldRadios");
        $f->attr('name', 'snippetsPath');
        $f->label = __('Snippets path', __FILE__);
        $f->description = __('This path will be checked for snippets.', __FILE__);
        $f->notes = __('Neither of these directories exist by default so you will need to create them.', __FILE__);
        $f->addOption('templates', $this->wire('config')->urls->templates.'TracyDebugger/snippets/');
        $f->addOption('assets', $this->wire('config')->urls->assets.'TracyDebugger/snippets/');
        if($data['snippetsPath']) $f->attr('value', $data['snippetsPath']);
        $fieldset->add($f);

        // Custom PHP Panel
        $fieldset = $this->wire('modules')->get("InputfieldFieldset");
        $fieldset->label = __('Custom PHP panel', __FILE__);
        $wrapper->add($fieldset);

        $f = $this->wire('modules')->get("InputfieldTextarea");
        $f->attr('name', 'customPhpCode');
        $f->label = __('Custom PHP code', __FILE__);
        $f->description = __('Use this PHP code block to return any output you want.', __FILE__);
        $f->notes = __('eg. return \'<a href="https://developers.google.com/speed/pagespeed/insights/?url=\'.$page->httpUrl.\'">Google PageSpeed</a>\';', __FILE__);
        if($data['customPhpCode']) $f->attr('value', $data['customPhpCode']);
        $fieldset->add($f);

        // Server Type Indicator
        $fieldset = $this->wire('modules')->get("InputfieldFieldset");
        $fieldset->label = __('Server type indicator', __FILE__);
        $wrapper->add($fieldset);

        $f = $this->wire('modules')->get("InputfieldCheckboxes");
        $f->attr('name', 'styleWhere');
        $f->label = __('Where', __FILE__);
        $f->description = __('Add indicator based on server IP address and/or subdomain.', __FILE__);
        $f->columnWidth = 30;
        $f->addOption('backend', 'Backend');
        $f->addOption('frontend', 'Frontend');
        if($data['styleWhere']) $f->attr('value', $data['styleWhere']);
        $fieldset->add($f);

        $f = $this->wire('modules')->get("InputfieldTextarea");
        $f->attr('name', 'styleAdminColors');
        $f->label = __('Indicator colors', __FILE__);
        $f->showIf = "styleWhere.count>0";
        $f->description = __('Use "type|#color" entries to define indicator styling for each server type. "local" is determined by IP address. Other types are detected based on their existence in subdomain or TLD (eg. dev.mysite.com or mysite.dev), dependant on whether you include the period after (dev.ï¹¡) or before (ï¹¡.dev).', __FILE__);
        $f->notes = __("**DEFAULT**\nlocal|#FF9933\n*.local|#FF9933\n*.dev|#FF9933\ndev.*|#FF9933\n*.test|#FF9933\nstaging.*|#8b0066\n*.com|#009900", __FILE__);
        $f->columnWidth = 70;
        if($data['styleAdminColors']) $f->attr('value', $data['styleAdminColors']);
        $fieldset->add($f);

        $f = $this->wire('modules')->get("InputfieldRadios");
        $f->attr('name', 'styleAdminType');
        $f->label = __('Indicator type', __FILE__);
        $f->showIf = "styleWhere.count>0";
        $f->description = __('Choose custom if you want complete control', __FILE__);
        $f->notes = __('You will need to do a hard reload in your browser for these changes to take effect.', __FILE__);
        $f->addOption('default', 'Indicator on debug bar');
        $f->addOption('custom', 'Custom - control with CSS');
        $f->columnWidth = 30;
        if($data['styleAdminType']) $f->attr('value', $data['styleAdminType']);
        $fieldset->add($f);

        $f = $this->wire('modules')->get("InputfieldTextarea");
        $f->attr('name', 'styleAdminElements');
        $f->label = __('Custom indicator CSS', __FILE__);
        $f->showIf = "styleWhere.count>0, styleAdminType='custom'";
        $f->description = __('Use [color] and [type] shortcodes to add indicator based on server type.', __FILE__);
        $f->notes = __("**DEFAULT**\nbody::before {\n&nbsp;&nbsp;&nbsp;&nbsp;content: \"[type]\";\n&nbsp;&nbsp;&nbsp;&nbsp;background: [color];\n&nbsp;&nbsp;&nbsp;&nbsp;position: fixed;\n&nbsp;&nbsp;&nbsp;&nbsp;left: 0;\n&nbsp;&nbsp;&nbsp;&nbsp;bottom: 100%;\n&nbsp;&nbsp;&nbsp;&nbsp;color: #ffffff;\n&nbsp;&nbsp;&nbsp;&nbsp;width: 100vh;\n&nbsp;&nbsp;&nbsp;&nbsp;padding: 0;\n&nbsp;&nbsp;&nbsp;&nbsp;text-align: center;\n&nbsp;&nbsp;&nbsp;&nbsp;font-family: sans-serif;\n&nbsp;&nbsp;&nbsp;&nbsp;font-weight: 600;\n&nbsp;&nbsp;&nbsp;&nbsp;text-transform: uppercase;\n&nbsp;&nbsp;&nbsp;&nbsp;transform: rotate(90deg);\n&nbsp;&nbsp;&nbsp;&nbsp;transform-origin: bottom left;\n&nbsp;&nbsp;&nbsp;&nbsp;z-index: 999999;\n&nbsp;&nbsp;&nbsp;&nbsp;font-family: sans-serif;\n&nbsp;&nbsp;&nbsp;&nbsp;font-size: 11px;\n&nbsp;&nbsp;&nbsp;&nbsp;height: 13px;\n&nbsp;&nbsp;&nbsp;&nbsp;line-height: 13px;\n&nbsp;&nbsp;&nbsp;&nbsp;pointer-events: none;\n}\n", __FILE__);
        $f->columnWidth = 70;
        if($data['styleAdminElements']) $f->attr('value', $data['styleAdminElements']);
        $fieldset->add($f);



        // User DEV Template
        $fieldset = $this->wire('modules')->get("InputfieldFieldset");
        $fieldset->label = __('User dev template', __FILE__);
        $wrapper->add($fieldset);

        $f = $this->wire('modules')->get("InputfieldCheckbox");
        $f->attr('name', 'userDevTemplate');
        $f->label = __('Enable user dev template', __FILE__);
        $f->description = __('If user has a permission named to match the page template with the set suffix, the page will be rendered with that template file rather than the default.', __FILE__);
        $f->columnWidth = 50;
        $f->attr('checked', $data['userDevTemplate'] == '1' ? 'checked' : '' );
        $fieldset->add($f);

        $f = $this->wire('modules')->get("InputfieldText");
        $f->attr('name', 'userDevTemplateSuffix');
        $f->label = __('User dev template suffix', __FILE__);
        $f->description = __('Template file suffix. eg "dev" will render the homepage with the "home-dev.php" template file if the user has a matching permission (prefixed with "tracy"), eg. "tracy-home-dev".', __FILE__);
        $f->columnWidth = 50;
        if($data['userDevTemplateSuffix']) $f->attr('value', $data['userDevTemplateSuffix']);
        $fieldset->add($f);

        // User Bar
        $fieldset = $this->wire('modules')->get("InputfieldFieldset");
        $fieldset->label = __('User Bar', __FILE__);
        $wrapper->add($fieldset);

        $f = $this->wire('modules')->get("InputfieldCheckbox");
        $f->attr('name', 'showUserBar');
        $f->label = __('Show user bar', __FILE__);
        $f->description = __('This bar is shown to logged in users without permission for the Tracy debug bar (typically all non-superusers).', __FILE__);
        $f->columnWidth = 33;
        $f->attr('checked', $data['showUserBar'] == '1' ? 'checked' : '' );
        $fieldset->add($f);

        $f = $this->wire('modules')->get("InputfieldCheckbox");
        $f->attr('name', 'showUserBarTracyUsers');
        $f->label = __('Show user bar for Tracy users', __FILE__);
        $f->showIf = "showUserBar=1";
        $f->description = __('Also show the bar to users with Tracy debug bar permission.', __FILE__);
        $f->notes = __('Only recommended if you position this bar somewhere other than bottom right so it doesn\'t conflict with the Debug bar.', __FILE__);
        $f->columnWidth = 34;
        $f->showIf = "showUserBar=1";
        $f->attr('checked', $data['showUserBarTracyUsers'] == '1' ? 'checked' : '' );
        $fieldset->add($f);

        $f = $this->wire('modules')->get("InputfieldAsmSelect");
        $f->attr('name', 'userBarFeatures');
        $f->label = __('Features', __FILE__);
        $f->showIf = "showUserBar=1";
        $f->description = __('Determines which features are shown on the User Bar.', __FILE__);
        $f->notes = __('The Page Versions function requires that the user has the "tracy-page-versions" permission.', __FILE__);
        $f->columnWidth = 33;
        foreach(static::$userBarFeatures as $name => $label) {
            $f->addOption($name, $label);
        }
        if($data['userBarFeatures']) $f->attr('value', $data['userBarFeatures']);
        $fieldset->add($f);

        $f = $this->wire('modules')->get("InputfieldTextarea");
        $f->attr('name', 'userBarCustomFeatures');
        $f->label = __('Custom features', __FILE__);
        $f->showIf = "showUserBar=1";
        $f->description = __('Use this PHP code block to return any output you want.', __FILE__);
        $f->notes = __('eg. return \'<a href="https://developers.google.com/speed/pagespeed/insights/?url=\'.$page->httpUrl.\'" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" viewBox="0 0 452.555 452.555" style="enable-background:new 0 0 452.555 452.555;" xml:space="preserve" width="16px" height="16px"><path d="M404.927,209.431h47.175c-3.581-49.699-23.038-94.933-53.539-130.611l-33.715,33.715l-23.275-23.296l33.758-33.78     C339.826,24.353,294.527,4.206,244.591,0.194v48.923h-32.917V0C161.22,3.236,115.296,22.8,79.165,53.668l35.57,35.549     l-23.296,23.296L55.804,76.878C24.332,112.858,4.12,158.804,0.475,209.452h50.864v32.917H0.453     C8.93,359.801,106.646,452.555,226.256,452.555s217.347-92.754,225.846-210.186h-47.197L404.927,209.431L404.927,209.431z      M228.133,362.217c-24.116,0-43.659-19.522-43.659-43.681c0-17.839,10.742-33.176,26.144-39.928l16.394-151.707l4.034,0.043     l14.927,151.729c15.229,6.881,25.863,22.045,25.863,39.863C271.857,342.695,252.27,362.217,228.133,362.217z" fill="\'.$iconColor.\'"/></svg></a>\';', __FILE__);
        if($data['userBarCustomFeatures']) $f->attr('value', $data['userBarCustomFeatures']);
        $fieldset->add($f);

        $f = $this->wire('modules')->get("InputfieldSelect");
        $f->attr('name', 'userBarTopBottom');
        $f->label = __('Top / Bottom', __FILE__);
        $f->showIf = "showUserBar=1";
        $f->columnWidth = 50;
        $f->addOption('top', 'Top');
        $f->addOption('bottom', 'Bottom');
        if($data['userBarTopBottom']) $f->attr('value', $data['userBarTopBottom']);
        $fieldset->add($f);

        $f = $this->wire('modules')->get("InputfieldSelect");
        $f->attr('name', 'userBarLeftRight');
        $f->label = __('Left / Right', __FILE__);
        $f->showIf = "showUserBar=1";
        $f->columnWidth = 50;
        $f->addOption('left', 'Left');
        $f->addOption('right', 'Right');
        if($data['userBarLeftRight']) $f->attr('value', $data['userBarLeftRight']);
        $fieldset->add($f);

        $f = $this->wire('modules')->get("InputfieldText");
        $f->attr('name', 'userBarBackgroundColor');
        $f->label = __('Background color', __FILE__);
        $f->showIf = "showUserBar=1";
        $f->description = __('Leave blank for transparent/none', __FILE__);
        $f->notes = __('eg. #FFFFFF', __FILE__);
        $f->columnWidth = 33;
        if($data['userBarBackgroundColor']) $f->attr('value', $data['userBarBackgroundColor']);
        $fieldset->add($f);

        $f = $this->wire('modules')->get("InputfieldText");
        $f->attr('name', 'userBarBackgroundOpacity');
        $f->label = __('Background opacity', __FILE__);
        $f->showIf = "showUserBar=1";
        $f->notes = __('0 to 1', __FILE__);
        $f->columnWidth = 34;
        if($data['userBarBackgroundOpacity']) $f->attr('value', $data['userBarBackgroundOpacity']);
        $fieldset->add($f);

        $f = $this->wire('modules')->get("InputfieldText");
        $f->attr('name', 'userBarIconColor');
        $f->label = __('Icon color', __FILE__);
        $f->showIf = "showUserBar=1";
        $f->notes = __('eg. #666666', __FILE__);
        $f->columnWidth = 33;
        if($data['userBarIconColor']) $f->attr('value', $data['userBarIconColor']);
        $fieldset->add($f);

        // Method Shortcuts
        $fieldset = $this->wire('modules')->get("InputfieldFieldset");
        $fieldset->label = __('Method shortcuts', __FILE__);
        $wrapper->add($fieldset);

        $f = $this->wire('modules')->get("InputfieldCheckbox");
        $f->attr('name', 'enableShortcutMethods');
        $f->label = __('Enable shortcut methods', __FILE__);
        $f->description = __('Uncheck to not define any of the shortcut methods. If you are not going to use these in your templates, unchecking means that they will not be defined which may reduce possible future name clashes. If in doubt, uncheck and use the full methods:'."\n".'TD::addBreakpoint()'."\n".'TD::barDump()'."\n".'TD::barDumpBig()'."\n".'TD::barDumpLive()'."\n".'TD::debugAll()'."\n".'TD::dump()'."\n".'TD::fireLog()'."\n".'TD::log()'."\n".'TD::templateVars()'."\n".'TD::timer()', __FILE__);
        $f->notes = __('If this, or one of the shortcut methods is not enabled, but is called in your templates, all users will get a "call to undefined function" fatal error, so please be aware when using the shortcut methods in your templates if they are not enabled here.', __FILE__);
        $f->columnWidth = 50;
        $f->attr('checked', $data['enableShortcutMethods'] == '1' ? 'checked' : '' );
        $fieldset->add($f);

        $f = $this->wire('modules')->get("InputfieldCheckboxes");
        $f->attr('name', 'enabledShortcutMethods');
        $f->label = __('Enabled shortcuts', __FILE__);
        $f->description = __('Uncheck any shortcuts/aliases to methods that you do not want available.', __FILE__);
        $f->notes = __('Useful if any of these functions/methods are defined elswhere in your site and you are getting a "previously declared" fatal error.', __FILE__);
        $f->showIf = "enableShortcutMethods=1";
        $f->columnWidth = 50;
        $f->addOption('addBreakpoint', 'addBreakpoint() for TD::addBreakpoint()');
        $f->addOption('bp', 'bp() for TD::addBreakpoint()');
        $f->addOption('barDump', 'barDump() for TD::barDump()');
        $f->addOption('bd', 'bd() for TD::barDump()');
        $f->addOption('barDumpBig', 'barDumpBig() for TD::barDumpBig()');
        $f->addOption('bdb', 'bdb() for TD::barDumpBig()');
        $f->addOption('barDumpLive', 'barDumpLive() for TD::barDumpLive()');
        $f->addOption('bdl', 'bdl() for TD::barDumpLive()');
        $f->addOption('debugAll', 'debugAll() for TD::debugAll()');
        $f->addOption('da', 'da() for TD::debugAll()');
        $f->addOption('dump', 'dump() for TD::dump()');
        $f->addOption('d', 'd() for TD::dump()');
        $f->addOption('fireLog', 'fireLog() for TD::fireLog()');
        $f->addOption('fl', 'fl() for TD::fireLog()');
        $f->addOption('l', 'l() for TD::log()');
        $f->addOption('templateVars', 'templateVars() for TD::templateVars()');
        $f->addOption('tv', 'tv() for TD::templateVars()');
        $f->addOption('timer', 'timer() for TD::timer()');
        $f->addOption('t', 't() for TD::timer()');
        if($data['enabledShortcutMethods']) $f->attr('value', $data['enabledShortcutMethods']);
        $fieldset->add($f);

        // convert PW Info panel custom links page IDs into paths so we can export settings to another PW site
        $this->wire('modules')->addHookBefore('saveModuleConfigData', null, function($event) {
            if($this->wire('input')->get->name !== 'TracyDebugger') return;
            if(!$this->wire('input')->post->customPWInfoPanelLinks[0]) return;
            $data = $event->arguments[1];
            $customPWInfoPanelLinkPaths = array();
            $customPWInfoPanelLinks = $this->wire('input')->post->customPWInfoPanelLinks;
            if(method_exists($this->wire('pages'), 'getPath') && version_compare($this->wire('config')->version, '3.0.73', '>=')) {
                foreach(explode(',',$customPWInfoPanelLinks[0]) as $pid) {
                    array_push($customPWInfoPanelLinkPaths, $this->wire('pages')->getPath($pid));
                }
            }
            // fallback for PW < 3.0.6 when getPath method did not exist
            else {
                foreach(explode(',',$customPWInfoPanelLinks[0]) as $pid) {
                    array_push($customPWInfoPanelLinkPaths, $this->wire('pages')->get($pid)->path);
                }
            }
            $data['customPWInfoPanelLinks'] = $customPWInfoPanelLinkPaths;
            $event->arguments(1, $data);
        });

        return $wrapper;
    }

}
